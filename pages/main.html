<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="light dark">
  <title>ASGå¯¼æ’­ç«¯</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./css/main.css">
</head>

<body>
  <div class="app-sidebar">
    <div class="sidebar-header">
      <div class="app-logo">ASG Director</div>
      <span id="versionBadge" class="status-badge" onclick="checkUpdate()" style="cursor:pointer">v1.0.0</span>
    </div>

    <div class="sidebar-nav">
      <button class="nav-item active" id="nav-home" onclick="switchView('home')">
        <span class="nav-icon">ğŸ“‹</span> æœ¬åœ° BP
      </button>
      <button class="nav-item" id="nav-online" onclick="switchView('online')">
        <span class="nav-icon">ğŸŒ</span> è”ç½‘ BP
      </button>
      <button class="nav-item" id="nav-settings" onclick="switchView('settings')">
        <span class="nav-icon">ğŸ¨</span> MMD,å­—ä½“å’Œç»„ä»¶åŒ…
      </button>
      <button class="nav-item" id="nav-tools" onclick="switchView('tools')">
        <span class="nav-icon">ğŸ› ï¸</span> æ’ä»¶å’Œå¸ƒå±€åŒ…
      </button>

      <div style="height:1px; background:var(--border-color); margin: 8px 16px;"></div>
      <div style="padding:0 16px; font-size:12px; color:var(--text-secondary); margin-bottom:4px;">æ’ä»¶</div>

      <div id="pluginMenubar" style="display:flex; flex-direction:column; gap:4px;"></div>
    </div>

    <div class="sidebar-footer">
      <div class="user-pill" onclick="currentUser ? logout() : showLoginModal()">
        <div id="userInfo" style="flex:1; display:flex; align-items:center; gap:8px;">
          <span id="userStatus">æœªç™»å½•</span>
        </div>
        <span id="loginBtn" style="font-size:12px;">ç™»å½•</span>
        <span id="logoutBtn" style="font-size:12px; display:none;">é€€å‡º</span>
      </div>
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button class="btn-ghost" id="updateBtn" onclick="checkUpdate()" title="æ£€æŸ¥æ›´æ–°"
          style="flex:1; justify-content:center;"><span class="update-text">æ›´æ–°</span></button>
        <button class="btn-ghost" id="themeToggleBtn" onclick="toggleTheme()"
          style="flex:1; justify-content:center;"><span id="themeIcon">ğŸŒ™</span></button>
        <button class="btn-ghost" id="helpBtn" onclick="ASGOnboarding.forceStart()" title="æ–°æ‰‹å¼•å¯¼"
          style="flex:1; justify-content:center;">â“</button>
      </div>
    </div>
  </div>

  <div class="app-main">
    <div class="view-container">
      <div id="mainContainer">

        <!-- View: Home -->
        <div id="view-home" class="view-section active">
          <div class="section-header">
            <h1 class="section-title">æœ¬åœ° BP</h1>
            <p class="section-desc">å¿«é€Ÿå¼€å§‹ä¸€åœºä¸“ä¸šçš„èµ›äº‹å¯¼æ’­</p>
          </div>

          <div class="grid-2">
            <div class="feature-card hero-card">
              <div class="hero-content">
                <h3 style="font-size: 32px; margin-bottom: 12px;">æœ¬åœ° BP æ¨¡å¼</h3>
                <p style="font-size: 16px; margin-bottom: 24px;">å•æœºå¯¼æ’­ï¼Œå¿«é€Ÿå¯åŠ¨ï¼Œæ— éœ€è”ç½‘è¿æ¥ã€‚</p>
                <button class="btn btn-primary btn-lg" id="localBpBtn">ç«‹å³å¼€å§‹</button>
              </div>
              <div style="font-size:100px; opacity:0.8;">ğŸ“‹</div>
            </div>





            <div class="feature-card">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h3>èµ›ç¨‹ï¼ˆIdveventå¯¹æ¥åŠŸèƒ½ï¼‰</h3>
                <button class="btn btn-secondary" id="refreshScheduleBtn" onclick="loadIdveventSchedules()">
                  ğŸ”„ åˆ·æ–°
                </button>
              </div>

              <div class="control-group" style="margin-bottom:16px;">
                <label class="control-label">èµ›äº‹ID (å¯é€‰ï¼Œç•™ç©ºè·å–æ‰€æœ‰)</label>
                <input type="text" id="idveventEventId" class="form-input"
                  placeholder="ä¾‹å¦‚: 550e8400-e29b-41d4-a716-446655440000">
              </div>

              <div id="idveventScheduleList" style="max-height:400px; overflow-y:auto;">
                <div style="text-align:center; padding:20px; color:var(--text-secondary);">
                  ç‚¹å‡»"åˆ·æ–°"æŒ‰é’®åŠ è½½èµ›ç¨‹
                </div>
              </div>
            </div>
          </div>

          <div class="feature-card" id="teamManagerCard" style="margin-top:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
              <h3>é˜Ÿä¼ç®¡ç†å™¨</h3>
              <div style="display:flex; align-items:center; gap:10px;">
                <span id="teamManagerCount" style="font-size:12px; color:var(--text-secondary);">æœªå¯¼å…¥</span>
                <button class="btn btn-ghost" id="teamManagerClearBtn" style="font-size:12px;">æ¸…ç©º</button>
              </div>
            </div>

            <div class="control-group" style="margin-bottom:16px;">
              <label class="control-label">å¯¼å…¥èµ›äº‹é˜Ÿä¼ CSV</label>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <input type="file" id="teamCsvInput" class="form-input" accept=".csv">
                <button class="btn btn-secondary" id="importTeamCsvBtn">å¯¼å…¥</button>
              </div>
            </div>

            <div class="grid-2" style="margin-bottom:16px;">
              <div>
                <label class="control-label">Aé˜Ÿ</label>
                <select id="teamManagerTeamA" class="form-select"></select>
                <div id="teamManagerPreviewA" style="margin-top:8px; font-size:12px; color:var(--text-secondary);"></div>
              </div>
              <div>
                <label class="control-label">Bé˜Ÿ</label>
                <select id="teamManagerTeamB" class="form-select"></select>
                <div id="teamManagerPreviewB" style="margin-top:8px; font-size:12px; color:var(--text-secondary);"></div>
              </div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn btn-primary" id="applyTeamsToLocalBpBtn">åº”ç”¨åˆ°æœ¬åœ°BP</button>
            </div>
          </div>

          <div id="pluginCardsSection"
            style="margin-top:40px; display:none; border-top: 1px solid var(--border-color); padding-top: 30px;">
            <div class="section-header" style="display:flex; align-items:center; gap:10px; margin-bottom: 20px;">
              <h2 class="section-title" style="font-size:20px; margin:0;">ğŸ§© æ’ä»¶</h2>
              <span class="section-desc">æ¥è‡ªå·²å®‰è£…çš„æ’ä»¶</span>
            </div>
            <div id="pluginCardsGrid" class="grid-2"></div>
          </div>
        </div>

        <!-- View: Online -->
        <div id="view-online" class="view-section">
          <div class="section-header">
            <h1 class="section-title">è”ç½‘ BP</h1>
            <p class="section-desc">åˆ›å»ºæˆ¿é—´ï¼Œåˆ†å‘é“¾æ¥ï¼Œå¼€å§‹æ¯”èµ›ã€‚</p>
          </div>

          <div class="grid-2">
            <div class="feature-card" id="onlineRoomCard">
              <h3>åˆ›å»ºæ–°æˆ¿é—´</h3>
              <div class="control-group">
                <label class="control-label">æœåŠ¡å™¨</label>
                <input type="text" id="serverUrl" class="form-input" value="https://api.idvevent.cn">
              </div>
              <div class="grid-2" style="margin-bottom:16px;">
                <div>
                  <label class="control-label">èµ›åˆ¶</label>
                  <select id="boType" class="form-select">
                    <option value="3">BO3</option>
                    <option value="5">BO5</option>
                  </select>
                </div>
                <div>
                  <label class="control-label">èµ›äº‹ID</label>
                  <input type="text" id="eventId" class="form-input" placeholder="å¯é€‰">
                </div>
              </div>
              <div class="control-group">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                  <input type="checkbox" id="globalBan" checked> <span style="font-size:14px;">å¯ç”¨å…¨å±€ç¦é€‰</span>
                </label>
              </div>
              <button class="btn btn-primary" id="createBtn" style="width:100%">ğŸš€ åˆ›å»ºæˆ¿é—´</button>

              <div id="linksContainer"
                style="display:none; margin-top:20px; padding-top:20px; border-top:1px solid var(--border-color);">
                <div class="control-group">
                  <label class="control-label">Aé˜Ÿé“¾æ¥</label>
                  <div style="display:flex; gap:8px;">
                    <input type="text" id="teamALink" class="form-input" readonly>
                    <button class="btn btn-secondary" onclick="copyLink('teamALink')">å¤åˆ¶</button>
                  </div>
                </div>
                <div class="control-group">
                  <label class="control-label">Bé˜Ÿé“¾æ¥</label>
                  <div style="display:flex; gap:8px;">
                    <input type="text" id="teamBLink" class="form-input" readonly>
                    <button class="btn btn-secondary" onclick="copyLink('teamBLink')">å¤åˆ¶</button>
                  </div>
                </div>
                <div class="control-group">
                  <label class="control-label">è§‚ä¼—é“¾æ¥</label>
                  <div style="display:flex; gap:8px;">
                    <input type="text" id="spectatorLink" class="form-input" readonly>
                    <button class="btn btn-secondary" onclick="copyLink('spectatorLink')">å¤åˆ¶</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="feature-card">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h3>å†å²æˆ¿é—´</h3>
                <button class="btn btn-ghost" onclick="clearRoomHistory()" style="font-size:12px;">æ¸…ç©º</button>
              </div>
              <div id="roomHistorySection">
                <div id="roomHistoryList"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- View: Settings -->
        <div id="view-settings" class="view-section">
          <div class="section-header">
            <h1 class="section-title">è¡¨ç°è®¾ç½®</h1>
            <p class="section-desc">é…ç½® 3D æ¨¡å‹æ¸²æŸ“ã€å‰å°åˆ†è¾¨ç‡ä¸å…¨å±€æ ·å¼ã€‚</p>
          </div>

          <div class="tab-nav">
            <button class="tab-btn active" onclick="switchSettingTab('3d', event)">3D æ¨¡å‹</button>
            <button class="tab-btn" onclick="switchSettingTab('render', event)">æ¸²æŸ“åˆ†è¾¨ç‡</button>
            <button class="tab-btn" onclick="switchSettingTab('assets', event)">å­—ä½“ä¸èµ„æº</button>
          </div>

          <div id="setting-tab-3d">
            <div class="feature-card" id="model3dSettingsCard">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <label
                  style="display:flex; align-items:center; gap:10px; cursor:pointer; font-size:16px; font-weight:bold;">
                  <input type="checkbox" id="enable3dModels" class="switch-input"> å¯ç”¨ 3D æ¨¡å‹
                </label>
                <div style="display:flex; align-items:center; gap:12px;">
                  <button class="btn btn-sm btn-secondary" onclick="ASGOnboarding.startMMDTutorial()">ğŸ“– é…ç½®æ•™ç¨‹</button>
                  <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                    <input type="checkbox" id="model3dAutoApply"> å®æ—¶åº”ç”¨ä¿®æ”¹
                  </label>
                </div>
              </div>

              <div class="settings-grid">
                <div class="control-group">
                  <label class="control-label">æ±‚ç”Ÿè€…æ¨¡å‹ç›®å½•</label>
                  <div style="display:flex; gap:8px;">
                    <input id="survivorModelDir" class="form-input" placeholder="Path...">
                    <button class="btn btn-secondary" onclick="pickFolderFor('survivorModelDir')">...</button>
                  </div>
                </div>
                <div class="control-group">
                  <label class="control-label">ç›‘ç®¡è€…æ¨¡å‹ç›®å½•</label>
                  <div style="display:flex; gap:8px;">
                    <input id="hunterModelDir" class="form-input" placeholder="Path...">
                    <button class="btn btn-secondary" onclick="pickFolderFor('hunterModelDir')">...</button>
                  </div>
                </div>
                <div class="control-group">
                  <label class="control-label">æ±‚ç”Ÿè€…åŠ¨ä½œç›®å½•</label>
                  <div style="display:flex; gap:8px;">
                    <input id="survivorMotionDir" class="form-input" placeholder="Path...">
                    <button class="btn btn-secondary" onclick="pickFolderFor('survivorMotionDir')">...</button>
                  </div>
                </div>
                <div class="control-group">
                  <label class="control-label">ç›‘ç®¡è€…åŠ¨ä½œç›®å½•</label>
                  <div style="display:flex; gap:8px;">
                    <input id="hunterMotionDir" class="form-input" placeholder="Path...">
                    <button class="btn btn-secondary" onclick="pickFolderFor('hunterMotionDir')">...</button>
                  </div>
                </div>

                <div class="control-group"><label class="control-label">æŠ—é”¯é½¿</label><select id="render3dAntialias"
                    class="form-select">
                    <option value="true">å¼€å¯</option>
                    <option value="false">å…³é—­</option>
                  </select></div>
                <div class="control-group"><label class="control-label">åƒç´ æ¯”</label><select id="render3dPixelRatio"
                    class="form-select">
                    <option value="1">1x</option>
                    <option value="1.5">1.5x</option>
                    <option value="2">2x</option>
                  </select></div>
                <div class="control-group"><label class="control-label">ç›®æ ‡ FPS</label><input type="number"
                    id="model3dTargetFPS" class="form-input" value="30"></div>
                <div class="control-group"><label class="control-label">é˜´å½±è´¨é‡</label><select id="render3dShadowQuality"
                    class="form-select">
                    <option value="1024">ä¸­</option>
                    <option value="2048">é«˜</option>
                  </select></div>
                <div class="control-group"><label class="control-label">Toon é£æ ¼</label>
                  <div style="display:flex; align-items:center; gap:10px;"><input type="checkbox"
                      id="render3dEnableToon"> <span>å¯ç”¨ Toon</span></div>
                </div>
                <div class="control-group"><label class="control-label">æè¾¹</label>
                  <div style="display:flex; align-items:center; gap:10px;"><input type="checkbox"
                      id="render3dEnableOutline"> <span>å¯ç”¨æè¾¹</span></div>
                </div>
              </div>

              <div style="display:none">
                <input id="defaultMotionVmd"><input id="render3dEnableShadows"><input id="render3dToonGradient">
                <input id="render3dOutlineThickness"><input id="render3dOutlineColor"><input id="render3dOutlineAlpha">
                <input id="render3dAmbientColor"><input id="render3dAmbientIntensity">
                <input id="render3dDirectionalColor"><input id="render3dDirectionalIntensity">
                <input id="render3dLightPosX"><input id="render3dLightPosY"><input id="render3dLightPosZ">
              </div>

              <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn btn-secondary" onclick="loadModel3dSettings()">åˆ·æ–°è®¾ç½®</button>
                <button class="btn btn-primary" onclick="applyModel3dSettings(true)">ä¿å­˜å¹¶åº”ç”¨</button>
              </div>
            </div>
          </div>

          <div id="setting-tab-render" style="display:none;">
            <div class="feature-card">
              <h3>OBS å‰å°è¾“å‡º</h3>
              <div class="control-group">
                <label class="control-label">è¾“å‡ºåˆ†è¾¨ç‡</label>
                <select id="frontendResolutionPreset" class="form-select" onchange="onFrontendResPresetChange()">
                  <option value="1920x1080">1080p</option>
                  <option value="2560x1440">1440p</option>
                  <option value="3840x2160">4K</option>
                  <option value="custom">è‡ªå®šä¹‰</option>
                </select>
              </div>
              <div class="grid-2">
                <input type="number" id="frontendResWidth" class="form-input" placeholder="W">
                <input type="number" id="frontendResHeight" class="form-input" placeholder="H">
              </div>
              <p id="frontendResHint" style="font-size:12px; color:var(--text-secondary); margin:10px 0;">...</p>
              <button class="btn btn-primary" onclick="applyFrontendResolution()">åº”ç”¨åˆ†è¾¨ç‡</button>

              <div style="margin-top:30px; border-top:1px solid var(--border-color); padding-top:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <div>
                    <h4>é€æ˜èƒŒæ™¯æ¨¡å¼</h4>
                    <p style="font-size:12px; color:var(--text-secondary);">OBS æ¨æµæ—¶èƒŒæ™¯é€æ˜</p>
                  </div>
                  <label class="switch">
                    <input type="checkbox" id="transparentBackgroundToggle" onchange="toggleTransparentBackground()">
                    <span class="slider"></span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div id="setting-tab-assets" style="display:none;">
            <div class="feature-card">
              <h3>èµ„æºç®¡ç†</h3>
              <div class="grid-2">
                <button class="btn btn-secondary" onclick="openCharacterManager()">ğŸ­ è§’è‰²å›¾ç‰‡ç®¡ç†</button>
                <button class="btn btn-secondary" onclick="openFontSettings()">ğŸ”¤ å…¨å±€å­—ä½“è®¾ç½®</button>
                <button class="btn btn-primary" onclick="openComponentEditor()">ğŸ¨ è‡ªå®šä¹‰ç»„ä»¶è®¾è®¡å™¨</button>
                <button class="btn btn-primary" onclick="openAnimationEditor()">ğŸ¬ åŠ¨ç”»ç¼–è¾‘å™¨</button>
              </div>
            </div>
          </div>
        </div>

        <!-- View: Tools/Store -->
        <div id="view-tools" class="view-section">
          <div class="section-header">
            <h1 class="section-title">å·¥å…·ä¸å•†åº—</h1>
          </div>

          <div class="grid-3">
            <div class="feature-card" id="storeCard">
              <h3>å¸ƒå±€å•†åº—</h3>
              <p>ä¸‹è½½ç²¾ç¾çš„å®˜æ–¹/ç¤¾åŒºå¸ƒå±€åŒ…ã€‚</p>
              <p id="packCount" style="color:#FFD700; font-weight:bold;">10+</p>
              <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="openStore()">æ‰“å¼€å¸ƒå±€å•†åº—</button>
            </div>

            <div class="feature-card">
              <h3>æ’ä»¶ä¸­å¿ƒ</h3>
              <p>æ‰©å±•å¯¼æ’­ç«¯åŠŸèƒ½ã€‚</p>
              <button class="btn btn-secondary" style="width:100%; margin-top:10px;"
                onclick="openPluginStore()">æ’ä»¶å•†åº—</button>
              <button class="btn btn-ghost" style="width:100%; margin-top:5px;"
                onclick="openPluginManager()">ç®¡ç†å·²å®‰è£…</button>
            </div>

            <div class="feature-card">
              <h3>å¸ƒå±€ç®¡ç†</h3>
              <p>å¯¼å…¥æˆ–å¯¼å‡ºæ‚¨çš„ BP å¸ƒå±€åŒ…ï¼Œæˆ–é‡ç½®ä¸ºé»˜è®¤å€¼ã€‚</p>
              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:20px;">
                <button class="btn btn-secondary" onclick="importBpPack()">ğŸ“¥ å¯¼å…¥</button>
                <button class="btn btn-secondary" onclick="exportBpPack()">ğŸ“¤ å¯¼å‡º</button>
                <button class="btn btn-ghost" onclick="resetLayout()"
                  style="width:100%; border: 1px solid rgba(255,255,255,0.1); margin-top:10px;">ğŸ”„ é‡ç½®ä¸ºé»˜è®¤</button>
              </div>
            </div>
          </div>


        </div>

      </div>

      <div id="pluginPagesContainer"></div>

    </div>
  </div>

  <div id="statusToast" class="status-toast"></div>

  <div class="modal" id="loginModal">
    <div class="modal-content">
      <h3 style="margin-bottom:20px; text-align:center;">ç™»å½•è´¦å·</h3>
      <input type="email" id="loginEmail" class="form-input" placeholder="Email" style="margin-bottom:10px;">
      <input type="password" id="loginPassword" class="form-input" placeholder="Password" style="margin-bottom:10px;">
      <div id="loginError" style="color:red; font-size:12px; margin-bottom:10px; display:none;"></div>
      <div style="display:flex; gap:10px;">
        <button class="btn btn-secondary" onclick="hideLoginModal()" style="flex:1">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="doLoginBtn" onclick="doLogin()" style="flex:1">ç™»å½•</button>
      </div>
    </div>
  </div>

  <script src="./js/main-logic.js"></script>
  <script src="./js/signalr.min.js"></script>
  <script src="./js/onboarding.js"></script>
  <script>
    let connection = null
    let roomData = null
    let currentUser = null
    let myEvents = []
    let selectedEventId = null
    let eventMatches = []
    let roomHistory = [] // æˆ¿é—´å†å²è®°å½•
    let currentRoomId = null // å½“å‰æ´»åŠ¨çš„æˆ¿é—´ID

    const serverUrlInput = document.getElementById('serverUrl')
    const eventIdInput = document.getElementById('eventId')
    const boTypeSelect = document.getElementById('boType')
    const globalBanCheckbox = document.getElementById('globalBan')
    const createBtn = document.getElementById('createBtn')
    const linksContainer = document.getElementById('linksContainer')
    const statusToast = document.getElementById('statusToast')

    // åŠ è½½æˆ¿é—´å†å²è®°å½•
    function loadRoomHistory() {
      const saved = localStorage.getItem('asg_room_history')
      if (saved) {
        try {
          roomHistory = JSON.parse(saved)
          renderRoomHistory()
        } catch (e) {
          console.error('åŠ è½½æˆ¿é—´å†å²å¤±è´¥:', e)
          roomHistory = []
        }
      }
    }

    // ä¿å­˜æˆ¿é—´å†å²è®°å½•
    function saveRoomHistory() {
      localStorage.setItem('asg_room_history', JSON.stringify(roomHistory))
      renderRoomHistory()
    }

    // æ·»åŠ æˆ¿é—´åˆ°å†å²è®°å½•
    function addRoomToHistory(roomData, links = {}) {
      const existingIndex = roomHistory.findIndex(r => r.roomId === roomData.roomId)

      const historyItem = {
        roomId: roomData.roomId,
        serverUrl: roomData.serverUrl,
        eventId: roomData.eventId || '',
        boType: roomData.boType,
        globalBanEnabled: roomData.globalBanEnabled,
        createdAt: new Date().toISOString(),
        teamAName: roomData.teamAName || 'Aé˜Ÿ',
        teamBName: roomData.teamBName || 'Bé˜Ÿ',
        teamALink: links.teamALink || '',
        teamBLink: links.teamBLink || '',
        spectatorLink: links.spectatorLink || ''
      }

      if (existingIndex > -1) {
        roomHistory[existingIndex] = historyItem
      } else {
        roomHistory.unshift(historyItem)
        if (roomHistory.length > 5) {
          roomHistory = roomHistory.slice(0, 5)
        }
      }

      currentRoomId = roomData.roomId
      saveRoomHistory()
    }

    // æ¸²æŸ“æˆ¿é—´å†å²åˆ—è¡¨
    function renderRoomHistory() {
      const section = document.getElementById('roomHistorySection')
      const list = document.getElementById('roomHistoryList')

      if (roomHistory.length === 0) {
        section.style.display = 'none'
        return
      }

      section.style.display = 'block'

      list.innerHTML = roomHistory.map(room => {
        const isActive = room.roomId === currentRoomId
        const date = new Date(room.createdAt).toLocaleString('zh-CN', {
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        })

        const hasLinks = room.teamALink || room.teamBLink || room.spectatorLink

        return `
          <div class="room-history-item ${isActive ? 'active' : ''}" data-room-id="${room.roomId}">
            <div class="room-history-info">
              <div class="room-history-id">ğŸ® æˆ¿é—´ ${room.roomId}</div>
              <div class="room-history-meta">
                ${room.teamAName} vs ${room.teamBName} â€¢ BO${room.boType} â€¢ ${date}
              </div>
              ${hasLinks ? `
                <div style="margin-top: 6px; display: flex; gap: 6px; flex-wrap: wrap;">
                  ${room.teamALink ? `<button class="room-history-btn" style="background: rgba(100, 181, 246, 0.2); color: #64b5f6; font-size: 10px;" onclick="copyRoomLink('${room.teamALink}', 'Aé˜Ÿ')">ğŸ“‹ Aé˜Ÿ</button>` : ''}
                  ${room.teamBLink ? `<button class="room-history-btn" style="background: rgba(239, 83, 80, 0.2); color: #ef5350; font-size: 10px;" onclick="copyRoomLink('${room.teamBLink}', 'Bé˜Ÿ')">ğŸ“‹ Bé˜Ÿ</button>` : ''}
                  ${room.spectatorLink ? `<button class="room-history-btn" style="background: rgba(255, 215, 0, 0.2); color: #ffd700; font-size: 10px;" onclick="copyRoomLink('${room.spectatorLink}', 'è§‚ä¼—')">ğŸ“‹ è§‚ä¼—</button>` : ''}
                </div>
              ` : ''}
            </div>
            <div class="room-history-actions">
              ${!isActive ? `<button class="room-history-btn use" onclick="useRoomFromHistory('${room.roomId}')">ä½¿ç”¨</button>` : '<span style="color: #81c784; font-size: 11px;">âœ“ å½“å‰</span>'}
              <button class="room-history-btn delete" onclick="deleteRoomFromHistory('${room.roomId}')">Ã—</button>
            </div>
          </div>
        `
      }).join('')
    }

    // ä½¿ç”¨å†å²æˆ¿é—´
    async function useRoomFromHistory(roomId) {
      const room = roomHistory.find(r => r.roomId === roomId)
      if (!room) return

      // å…ˆå…³é—­ç°æœ‰çš„çª—å£
      try {
        await window.electronAPI.closeBpWindows()
        showStatus('æ­£åœ¨åˆ‡æ¢æˆ¿é—´...', 'info')
      } catch (e) {
        console.warn('å…³é—­çª—å£æ—¶å‡ºé”™:', e)
      }

      document.getElementById('serverUrl').value = room.serverUrl
      document.getElementById('eventId').value = room.eventId
      document.getElementById('boType').value = room.boType
      document.getElementById('globalBan').checked = room.globalBanEnabled

      try {
        const conn = await connectToServer()
        if (!conn) return

        try {
          await conn.invoke('JoinRoom', roomId, '', 'spectator')

          currentRoomId = roomId
          const roomData = {
            roomId: roomId,
            serverUrl: room.serverUrl,
            eventId: room.eventId,
            boType: room.boType,
            globalBanEnabled: room.globalBanEnabled,
            teamAName: room.teamAName,
            teamBName: room.teamBName
          }

          await window.electronAPI.openBpWindows(roomData)
          showStatus('å·²é‡æ–°è¿æ¥åˆ°æˆ¿é—´', 'success')
          renderRoomHistory()

        } catch (e) {
          showStatus('æˆ¿é—´å·²å¤±æ•ˆï¼Œè¯·åˆ›å»ºæ–°æˆ¿é—´', 'warning')
        }

        await conn.stop()
      } catch (e) {
        showStatus('è¿æ¥å¤±è´¥: ' + e.message, 'error')
      }
    }

    // åˆ é™¤å†å²æˆ¿é—´
    function deleteRoomFromHistory(roomId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return

      roomHistory = roomHistory.filter(r => r.roomId !== roomId)
      if (currentRoomId === roomId) {
        currentRoomId = null
      }
      saveRoomHistory()
      showStatus('å·²åˆ é™¤', 'info')
    }

    // æ¸…ç©ºå†å²è®°å½•
    function clearRoomHistory() {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) return

      roomHistory = []
      currentRoomId = null
      saveRoomHistory()
      showStatus('å·²æ¸…ç©º', 'info')
    }

    // åˆå§‹åŒ–æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
    async function checkAuthStatus() {
      try {
        const result = await window.electronAPI.getAuthStatus()
        if (result.isLoggedIn && result.user) {
          currentUser = result.user
          updateUserUI()
          loadMyEvents()
        }
      } catch (e) {
        console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', e)
      }
    }

    function updateUserUI() {
      const userInfo = document.getElementById('userInfo')
      const loginBtn = document.getElementById('loginBtn')
      const logoutBtn = document.getElementById('logoutBtn')

      if (currentUser) {
        const displayName = currentUser.fullName || currentUser.email || 'ç”¨æˆ·'
        userInfo.innerHTML = `
          <div class="user-avatar">${displayName[0].toUpperCase()}</div>
          <span style="color: #ddd;">${displayName}</span>
        `
        loginBtn.style.display = 'none'
        logoutBtn.style.display = 'inline-block'
      } else {
        userInfo.innerHTML = '<span id="userStatus" style="color: #888;">æœªç™»å½•</span>'
        loginBtn.style.display = 'inline-block'
        logoutBtn.style.display = 'none'
      }
    }

    function showLoginModal(message) {
      if (message) {
        const errorDiv = document.getElementById('loginError')
        errorDiv.textContent = message
        errorDiv.style.display = 'block'
      }
      document.getElementById('loginModal').classList.add('show')
      document.getElementById('loginEmail').focus()
    }

    function hideLoginModal() {
      document.getElementById('loginModal').classList.remove('show')
      document.getElementById('loginEmail').value = ''
      document.getElementById('loginPassword').value = ''
      document.getElementById('loginError').style.display = 'none'
    }

    async function doLogin() {
      const email = document.getElementById('loginEmail').value.trim()
      const password = document.getElementById('loginPassword').value
      const errorDiv = document.getElementById('loginError')
      const loginBtn = document.getElementById('doLoginBtn')

      if (!email || !password) {
        errorDiv.textContent = 'è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç '
        errorDiv.style.display = 'block'
        return
      }

      loginBtn.disabled = true
      loginBtn.textContent = 'ç™»å½•ä¸­...'

      // å…ˆè®© UI å®Œæ•´æ¸²æŸ“ä¸€å¸§ï¼Œé¿å…â€œç‚¹å‡»ç™»å½•åç•Œé¢å¡ä½/ä¸åˆ·æ–°â€çš„è§‚æ„Ÿ
      await new Promise(requestAnimationFrame)

      try {
        const result = await window.electronAPI.login(email, password)
        if (result.success) {
          currentUser = result.user
          hideLoginModal()
          updateUserUI()
          loadMyEvents()
          showStatus('ç™»å½•æˆåŠŸ', 'success')
        } else {
          errorDiv.textContent = result.error || 'ç™»å½•å¤±è´¥'
          errorDiv.style.display = 'block'
        }
      } catch (e) {
        errorDiv.textContent = e.message || 'ç™»å½•å¤±è´¥'
        errorDiv.style.display = 'block'
      }

      loginBtn.disabled = false
      loginBtn.textContent = 'ç™»å½•'
    }

    async function logout() {
      try {
        await window.electronAPI.logout()
        currentUser = null
        myEvents = []
        updateUserUI()
        renderPredictionSection()
        showStatus('å·²é€€å‡ºç™»å½•', 'info')
      } catch (e) {
        console.error('é€€å‡ºç™»å½•å¤±è´¥:', e)
      }
    }

    async function loadMyEvents() {
      if (!currentUser) return

      try {
        const result = await window.electronAPI.getMyEvents()
        if (result.success) {
          myEvents = result.data || []
          renderPredictionSection()
        }
      } catch (e) {
        console.error('åŠ è½½èµ›äº‹å¤±è´¥:', e)
      }
    }

    // Theme toggle: persist to localStorage and notify other windows
    function getSystemTheme() {
      try {
        return (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light'
      } catch {
        return 'light'
      }
    }

    function updateThemeToggleUI(theme) {
      const icon = document.getElementById('themeIcon')
      const text = document.getElementById('themeText')
      if (!icon || !text) return
      if (theme === 'dark') { icon.textContent = 'ğŸŒ™'; text.textContent = 'æ·±è‰²' }
      else { icon.textContent = 'â˜€ï¸'; text.textContent = 'æµ…è‰²' }
    }

    function applyTheme(theme, persist = true) {
      try {
        const t = theme === 'dark' ? 'dark' : 'light'
        document.documentElement.setAttribute('data-theme', t)
        updateThemeToggleUI(t)

        if (persist) localStorage.setItem('asg_theme', t)

        // notify other windows via main-process broadcast
        if (window.electronAPI && window.electronAPI.sendToFrontend) {
          window.electronAPI.sendToFrontend({ type: 'theme-changed', theme: t })
        }
      } catch (e) {
        console.warn('applyTheme error', e)
      }
    }

    function toggleTheme() {
      const saved = localStorage.getItem('asg_theme')
      const current = (saved === 'dark' || saved === 'light') ? saved : getSystemTheme()
      const next = current === 'dark' ? 'light' : 'dark'
      applyTheme(next, true)
    }

    // Apply persisted theme at startup (no saved => follow system, but update button text)
    ; (function () {
      const saved = localStorage.getItem('asg_theme')
      if (saved === 'dark' || saved === 'light') {
        applyTheme(saved, false)
      } else {
        // follow system: don't set attribute, just reflect current mode on button
        document.documentElement.removeAttribute('data-theme')
        updateThemeToggleUI(getSystemTheme())
      }
    })()

    function renderPredictionSection() {
      const content = document.getElementById('predictionContent')

      if (!currentUser) {
        content.innerHTML = '<p style="color: #888; font-size: 13px; text-align: center; padding: 20px 0;">è¯·å…ˆç™»å½•è´¦å·ä»¥ä½¿ç”¨ç«çŒœåŠŸèƒ½</p>'
        return
      }

      if (!myEvents.length) {
        content.innerHTML = '<p style="color: #888; font-size: 13px; text-align: center; padding: 20px 0;">æ‚¨æš‚æ— ç®¡ç†çš„èµ›äº‹</p>'
        return
      }

      let html = `
        <select class="event-select" id="eventSelect" onchange="onEventSelect(this.value)">
          <option value="">é€‰æ‹©èµ›äº‹</option>
          ${myEvents.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}
        </select>
        <div id="matchList"></div>
      `

      content.innerHTML = html
    }

    async function onEventSelect(eventId) {
      selectedEventId = eventId
      const matchList = document.getElementById('matchList')

      if (!eventId) {
        matchList.innerHTML = ''
        return
      }

      matchList.innerHTML = '<p style="color: #888; font-size: 12px; text-align: center; padding: 10px;">åŠ è½½ä¸­...</p>'

      try {
        const result = await window.electronAPI.getEventMatches(eventId)
        console.log('èµ›ç¨‹æ•°æ®:', result)
        if (result.success) {
          eventMatches = Array.isArray(result.data) ? result.data : []
          console.log('è§£æåçš„èµ›ç¨‹:', eventMatches)
          renderMatchList()
        } else {
          matchList.innerHTML = `<p style="color: #e57373; font-size: 12px;">åŠ è½½å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}</p>`
        }
      } catch (e) {
        console.error('åŠ è½½èµ›ç¨‹å¼‚å¸¸:', e)
        matchList.innerHTML = `<p style="color: #e57373; font-size: 12px;">åŠ è½½å¤±è´¥: ${e.message}</p>`
      }
    }

    function renderMatchList() {
      const matchList = document.getElementById('matchList')

      if (!eventMatches.length) {
        matchList.innerHTML = '<p style="color: #888; font-size: 12px; text-align: center; padding: 10px;">æš‚æ— èµ›ç¨‹</p>'
        return
      }

      let html = eventMatches.map(m => `
        <div class="match-item" onclick="openPredictionWindow('${m.id}')">
          <div class="match-teams">${m.homeTeamName || 'ä¸»é˜Ÿ'} vs ${m.awayTeamName || 'å®¢é˜Ÿ'}</div>
          <div class="match-time">${new Date(m.matchTime).toLocaleString()}</div>
        </div>
      `).join('')

      matchList.innerHTML = html
    }

    async function openPredictionWindow(matchId) {
      try {
        await window.electronAPI.openPredictionWindow(matchId)
      } catch (e) {
        console.error('æ‰“å¼€ç«çŒœçª—å£å¤±è´¥:', e)
      }
    }

    function showStatus(message, type) {
      statusToast.textContent = message
      statusToast.className = `status-toast ${type}`
      statusToast.classList.add('show')
      setTimeout(() => {
        statusToast.classList.remove('show')
      }, 3000)
    }

    function copyLink(inputId) {
      const input = document.getElementById(inputId)
      input.select()
      document.execCommand('copy')
      showStatus('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success')
    }

    function copyRoomLink(link, teamName) {
      const textarea = document.createElement('textarea')
      textarea.value = link
      textarea.style.position = 'fixed'
      textarea.style.opacity = '0'
      document.body.appendChild(textarea)
      textarea.select()
      document.execCommand('copy')
      document.body.removeChild(textarea)
      showStatus(`${teamName}é“¾æ¥å·²å¤åˆ¶`, 'success')
    }

    // åˆ é™¤å¿«æ·æ“ä½œç›¸å…³å‡½æ•°
    async function openStore() {
      try {
        await window.electronAPI.openStore()
      } catch (e) {
        showStatus('æ‰“å¼€å•†åº—å¤±è´¥: ' + e.message, 'error')
      }
    }

    async function openPluginStore() {
      try {
        await window.electronAPI.openPluginStore()
      } catch (e) {
        showStatus('æ‰“å¼€æ’ä»¶å•†åº—å¤±è´¥: ' + e.message, 'error')
      }
    }

    async function openPluginManager() {
      try {
        const opener = window.electronAPI?.openPluginManager || window.plugins?.openPluginManager
        if (typeof opener !== 'function') {
          const keys = window.electronAPI ? Object.keys(window.electronAPI).slice(0, 8).join(', ') : 'none'
          showStatus('æ— æ³•æ‰“å¼€æ’ä»¶ç®¡ç†ï¼šé¢„åŠ è½½ API æœªæ³¨å…¥/ä¸å®Œæ•´ï¼ˆelectronAPI keys: ' + keys + 'ï¼‰', 'error')
          return
        }

        const result = await opener()
        if (result && result.success === false) {
          showStatus('æ‰“å¼€æ’ä»¶ç®¡ç†å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error')
        }
      } catch (e) {
        showStatus('æ‰“å¼€æ’ä»¶ç®¡ç†å¤±è´¥: ' + (e?.message || 'æœªçŸ¥é”™è¯¯'), 'error')
      }
    }

    async function openCharacterManager() {
      try {
        if (typeof window.electronAPI?.openCharacterManager !== 'function') {
          showStatus('æ— æ³•æ‰“å¼€è§’è‰²ç®¡ç†ï¼šAPI æœªæ³¨å…¥', 'error')
          return
        }

        const result = await window.electronAPI.openCharacterManager()
        if (result && result.success === false) {
          showStatus('æ‰“å¼€è§’è‰²ç®¡ç†å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error')
        }
      } catch (e) {
        showStatus('æ‰“å¼€è§’è‰²ç®¡ç†å¤±è´¥: ' + (e?.message || 'æœªçŸ¥é”™è¯¯'), 'error')
      }
    }

    async function openComponentEditor() {
      try {
        if (typeof window.electronAPI?.openComponentEditor !== 'function') {
          showStatus('æ— æ³•æ‰“å¼€ç»„ä»¶è®¾è®¡å™¨ï¼šAPI æœªæ³¨å…¥', 'error')
          return
        }

        const result = await window.electronAPI.openComponentEditor()
        if (result && result.success === false) {
          showStatus('æ‰“å¼€ç»„ä»¶è®¾è®¡å™¨å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error')
        }
      } catch (e) {
        showStatus('æ‰“å¼€ç»„ä»¶è®¾è®¡å™¨å¤±è´¥: ' + (e?.message || 'æœªçŸ¥é”™è¯¯'), 'error')
      }
    }



    // å¯¼å…¥å¸ƒå±€åŒ…
    async function importBpPack() {
      try {
        showStatus('æ­£åœ¨å¯¼å…¥å¸ƒå±€åŒ…...', 'info')
        const result = await window.electronAPI.importBpPack()
        if (result.success) {
          showStatus('âœ… å¸ƒå±€åŒ…å¯¼å…¥æˆåŠŸï¼å‰å°çª—å£å·²è‡ªåŠ¨æ›´æ–°', 'success')
        } else if (!result.canceled) {
          showStatus('å¯¼å…¥å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error')
        }
      } catch (e) {
        showStatus('å¯¼å…¥å¤±è´¥: ' + e.message, 'error')
      }
    }

    // å¯¼å‡ºå¸ƒå±€åŒ…
    async function exportBpPack() {
      try {
        showStatus('æ­£åœ¨å¯¼å‡ºå¸ƒå±€åŒ…...', 'info')
        const result = await window.electronAPI.exportBpPack()
        if (result.success) {
          showStatus('âœ… å¸ƒå±€åŒ…å¯¼å‡ºæˆåŠŸï¼', 'success')
        } else if (!result.canceled) {
          showStatus('å¯¼å‡ºå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error')
        }
      } catch (e) {
        showStatus('å¯¼å‡ºå¤±è´¥: ' + e.message, 'error')
      }
    }

    // é‡ç½®å¸ƒå±€
    async function resetLayout() {
      if (!confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤å¸ƒå±€å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰è®¾ç½®ã€‚')) return

      try {
        showStatus('æ­£åœ¨é‡ç½®å¸ƒå±€...', 'info')
        const result = await window.electronAPI.resetLayout()
        if (result.success) {
          showStatus('âœ… å¸ƒå±€å·²é‡ç½®ä¸ºé»˜è®¤ï¼å‰å°çª—å£å·²è‡ªåŠ¨æ›´æ–°', 'success')
        } else {
          showStatus('é‡ç½®å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error')
        }
      } catch (e) {
        showStatus('é‡ç½®å¤±è´¥: ' + e.message, 'error')
      }
    }

    // æ‰“å¼€å¸®åŠ©
    function openHelp() {
      const helpContent = `
        ã€ASGå¯¼æ’­ç«¯ä½¿ç”¨æŒ‡å—ã€‘
        
        1ï¸âƒ£ åˆ›å»ºæˆ¿é—´
        - ç‚¹å‡»"åˆ›å»ºæˆ¿é—´"æŒ‰é’®
        - å¤åˆ¶Aé˜Ÿ/Bé˜Ÿé“¾æ¥å‘ç»™é€‰æ‰‹
        - é€‰æ‰‹æ‰“å¼€é“¾æ¥å³å¯è¿›è¡ŒBP
        
        2ï¸âƒ£ å¯¼æ’­æ“ä½œ
        - æˆ¿é—´åˆ›å»ºåä¼šè‡ªåŠ¨æ‰“å¼€å‰å°å’Œåå°çª—å£
        - å‰å°çª—å£ç”¨äºOBSæ•è·å±•ç¤º
        - åå°çª—å£ç”¨äºæ§åˆ¶BPæµç¨‹
        
        3ï¸âƒ£ å¸ƒå±€å®šåˆ¶
        - åœ¨å‰å°çª—å£æ‹–æ‹½å…ƒç´ è°ƒæ•´ä½ç½®
        - å¸ƒå±€ä¼šè‡ªåŠ¨ä¿å­˜ï¼Œæ— éœ€æ‰‹åŠ¨ç‚¹å‡»ä¿å­˜
        - ä½¿ç”¨"å¯¼å‡ºå¸ƒå±€"ä¿å­˜ä¸ºæ–‡ä»¶åˆ†äº«
        - åœ¨å•†åº—ä¸‹è½½ç²¾ç¾å¸ƒå±€åŒ…
        - ä½¿ç”¨"å¯¼å…¥å¸ƒå±€"åº”ç”¨å¸ƒå±€åŒ…
        
        4ï¸âƒ£ å¿«æ·æ“ä½œ
        - å‰å°çª—å£æ”¯æŒæ‹–æ‹½è°ƒæ•´å…ƒç´ ä½ç½®
        - åŒå‡»å…ƒç´ å¯ç¼–è¾‘å±æ€§
        - æ‹–æ‹½/è°ƒæ•´å¤§å°åä¼šè‡ªåŠ¨ä¿å­˜
        - æ›´æ¢èƒŒæ™¯åä¼šè‡ªåŠ¨ä¿å­˜
        
        âœ¨ è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
        - æ‹–æ‹½å…ƒç´ å 0.5 ç§’è‡ªåŠ¨ä¿å­˜
        - è°ƒæ•´å¤§å°å 0.5 ç§’è‡ªåŠ¨ä¿å­˜
        - æ›´æ¢èƒŒæ™¯åç«‹å³è‡ªåŠ¨ä¿å­˜
        - çª—å£åŠ è½½æ—¶è‡ªåŠ¨ä¿å­˜å½“å‰å¸ƒå±€
        
        å¦‚éœ€æ›´å¤šå¸®åŠ©ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æˆ–æŸ¥çœ‹åœ¨çº¿æ–‡æ¡£ã€‚
      `
      alert(helpContent)
    }

    // ==================== å‰å°æ¸²æŸ“åˆ†è¾¨ç‡è®¾ç½® ====================
    function parsePresetResolution(value) {
      if (!value || value === 'custom') return null
      const m = String(value).match(/^(\d+)x(\d+)$/)
      if (!m) return null
      return { width: parseInt(m[1], 10), height: parseInt(m[2], 10) }
    }

    function setFrontendResInputs(width, height) {
      const w = document.getElementById('frontendResWidth')
      const h = document.getElementById('frontendResHeight')
      w.value = width
      h.value = height
    }

    function onFrontendResPresetChange() {
      const preset = document.getElementById('frontendResolutionPreset').value
      const r = parsePresetResolution(preset)
      if (r) {
        setFrontendResInputs(r.width, r.height)
      }
    }

    async function loadFrontendResolution() {
      try {
        const result = await window.electronAPI.getFrontendRenderResolution()
        if (!result || !result.success) return

        const saved = result.saved
        if (saved && saved.width && saved.height) {
          setFrontendResInputs(saved.width, saved.height)
          const presetValue = `${saved.width}x${saved.height}`
          const presetSelect = document.getElementById('frontendResolutionPreset')
          const hasPreset = Array.from(presetSelect.options).some(o => o.value === presetValue)
          presetSelect.value = hasPreset ? presetValue : 'custom'
        }

        const hint = document.getElementById('frontendResHint')
        if (result.current) {
          hint.textContent = `å½“å‰å‰å°çª—å£ï¼š${result.current.width}Ã—${result.current.height}ã€‚ç‚¹å‡»â€œåº”ç”¨åˆ†è¾¨ç‡â€å¯ç«‹å³è°ƒæ•´å¹¶ä¿å­˜ã€‚`
        }
      } catch (e) {
        console.warn('åŠ è½½å‰å°æ¸²æŸ“åˆ†è¾¨ç‡å¤±è´¥:', e)
      }
    }

    async function applyFrontendResolution() {
      const w = parseInt(document.getElementById('frontendResWidth').value, 10)
      const h = parseInt(document.getElementById('frontendResHeight').value, 10)
      if (!Number.isFinite(w) || !Number.isFinite(h)) {
        showStatus('è¯·è¾“å…¥åˆæ³•çš„å®½é«˜', 'error')
        return
      }

      try {
        const result = await window.electronAPI.setFrontendRenderResolution({ width: w, height: h })
        if (result && result.success) {
          showStatus(`âœ… å‰å°æ¸²æŸ“åˆ†è¾¨ç‡å·²è®¾ç½®ä¸º ${w}Ã—${h}`, 'success')
          const hint = document.getElementById('frontendResHint')
          if (result.current) {
            hint.textContent = `å½“å‰å‰å°çª—å£ï¼š${result.current.width}Ã—${result.current.height}ï¼ˆå·²åº”ç”¨å¹¶ä¿å­˜ï¼‰`
          }
        } else {
          showStatus('è®¾ç½®å¤±è´¥: ' + (result?.error || 'æœªçŸ¥é”™è¯¯'), 'error')
        }
      } catch (e) {
        showStatus('è®¾ç½®å¤±è´¥: ' + e.message, 'error')
      }
    }

    // ==================== é€æ˜èƒŒæ™¯è®¾ç½® ====================
    async function loadTransparentBackgroundSetting() {
      try {
        const result = await window.electronAPI.getTransparentBackground()
        if (result && result.success) {
          const toggle = document.getElementById('transparentBackgroundToggle')
          if (toggle) {
            toggle.checked = !!result.transparentBackground
          }
        }
      } catch (e) {
        console.warn('åŠ è½½é€æ˜èƒŒæ™¯è®¾ç½®å¤±è´¥:', e)
      }
    }

    async function toggleTransparentBackground() {
      const toggle = document.getElementById('transparentBackgroundToggle')
      const enabled = toggle ? toggle.checked : false

      try {
        const result = await window.electronAPI.setTransparentBackground(enabled)
        if (result && result.success) {
          showStatus(enabled ? 'âœ… å·²å¯ç”¨é€æ˜èƒŒæ™¯æ¨¡å¼ï¼Œå‰å°çª—å£å°†è‡ªåŠ¨åˆ·æ–°' : 'âœ… å·²ç¦ç”¨é€æ˜èƒŒæ™¯æ¨¡å¼ï¼Œå‰å°çª—å£å°†è‡ªåŠ¨åˆ·æ–°', 'success')
        } else {
          showStatus('è®¾ç½®å¤±è´¥: ' + (result?.error || 'æœªçŸ¥é”™è¯¯'), 'error')
          // æ¢å¤åŸçŠ¶æ€
          if (toggle) toggle.checked = !enabled
        }
      } catch (e) {
        showStatus('è®¾ç½®å¤±è´¥: ' + e.message, 'error')
        // æ¢å¤åŸçŠ¶æ€
        if (toggle) toggle.checked = !enabled
      }
    }

    function onTransparentBackgroundRowClick(e) {
      const toggle = document.getElementById('transparentBackgroundToggle')
      if (!toggle) return

      // ç‚¹å‡»åˆ°å¼€å…³æœ¬ä½“æ—¶ï¼Œè®© onchange è‡ªå·±å¤„ç†
      const target = e?.target
      if (target === toggle) return
      if (target && typeof target.closest === 'function' && target.closest('.switch')) return

      toggle.checked = !toggle.checked
      toggleTransparentBackground()
    }

    async function connectToServer() {
      const serverUrl = serverUrlInput.value.trim()
      if (!serverUrl) {
        showStatus('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€', 'error')
        return null
      }

      try {
        connection = new signalR.HubConnectionBuilder()
          .withUrl(`${serverUrl}/hubs/bp`)
          .withAutomaticReconnect()
          .build()

        await connection.start()
        showStatus('å·²è¿æ¥åˆ°æœåŠ¡å™¨', 'success')
        return connection
      } catch (error) {
        showStatus(`è¿æ¥å¤±è´¥: ${error.message}`, 'error')
        return null
      }
    }

    function getBpBaseUrlFromServerUrl(serverUrl) {
      const baseUrl = (serverUrl || '').trim().replace(/\/+$/, '')

      // æœ¬åœ°/è‡ªæ‰˜ç®¡åœºæ™¯ï¼šåšç«¯å£æ˜ å°„ï¼ˆå…¼å®¹æ—§ç«¯å£ï¼‰
      const portMapped = baseUrl
        .replace(':5068', ':5174')
        .replace(':5250', ':5173')

      // ç”Ÿäº§ç¯å¢ƒï¼šbp é¡µé¢åœ¨ bp å­åŸŸåï¼Œåç«¯ API åœ¨ api å­åŸŸå
      try {
        const url = new URL(portMapped)
        if (url.hostname === 'api.idvevent.cn') {
          url.hostname = 'bp.idvevent.cn'
        }
        return url.origin
      } catch {
        return portMapped
      }
    }

    async function createRoom() {
      createBtn.disabled = true
      createBtn.innerHTML = '<span>â³</span> åˆ›å»ºä¸­...'
      showStatus('æ­£åœ¨åˆ›å»ºæˆ¿é—´...', 'info')

      // å…ˆå…³é—­æ—§çª—å£
      try {
        await window.electronAPI.closeBpWindows()
      } catch (e) {
        console.warn('å…³é—­æ—§çª—å£æ—¶å‡ºé”™:', e)
      }

      try {
        const conn = await connectToServer()
        if (!conn) {
          createBtn.disabled = false
          createBtn.innerHTML = '<span>ğŸš€</span> åˆ›å»ºæˆ¿é—´'
          return
        }

        const eventId = eventIdInput.value.trim() || null
        const boType = parseInt(boTypeSelect.value)
        const globalBanEnabled = globalBanCheckbox.checked

        const result = await conn.invoke('CreateRoom', eventId, boType, globalBanEnabled)

        roomData = {
          ...result,
          serverUrl: serverUrlInput.value.trim()
        }

        // æ„å»ºå®Œæ•´é“¾æ¥
        const bpBaseUrl = getBpBaseUrlFromServerUrl(serverUrlInput.value)

        document.getElementById('teamALink').value = `${bpBaseUrl}/room/${result.roomId}?token=${result.teamAToken}&team=teamA`
        document.getElementById('teamBLink').value = `${bpBaseUrl}/room/${result.roomId}?token=${result.teamBToken}&team=teamB`
        document.getElementById('spectatorLink').value = `${bpBaseUrl}/spectator/${result.roomId}`

        const teamALink = document.getElementById('teamALink').value
        const teamBLink = document.getElementById('teamBLink').value
        const spectatorLink = document.getElementById('spectatorLink').value

        linksContainer.classList.add('show')
        showStatus('æˆ¿é—´åˆ›å»ºæˆåŠŸï¼æ­£åœ¨æ‰“å¼€å‰å°å’Œåå°...', 'success')

        // æ·»åŠ åˆ°å†å²è®°å½•ï¼ˆåŒ…å«é“¾æ¥ï¼‰
        addRoomToHistory(roomData, {
          teamALink,
          teamBLink,
          spectatorLink
        })

        // æ‰“å¼€å‰å°å’Œåå°çª—å£
        await window.electronAPI.createRoom(roomData)

        // é‡ç½®æŒ‰é’®çŠ¶æ€ï¼Œå…è®¸ç»§ç»­åˆ›å»º
        createBtn.disabled = false
        createBtn.innerHTML = '<span>ğŸš€</span> åˆ›å»ºæˆ¿é—´'

      } catch (error) {
        showStatus(`åˆ›å»ºå¤±è´¥: ${error.message}`, 'error')
        createBtn.disabled = false
        createBtn.innerHTML = '<span>ğŸš€</span> åˆ›å»ºæˆ¿é—´'
      }
    }

    createBtn.addEventListener('click', createRoom)

    // æœ¬åœ°BPæ¨¡å¼
    const localBpBtn = document.getElementById('localBpBtn')
    localBpBtn.addEventListener('click', async () => {
      try {
        const result = await window.electronAPI.invoke('open-local-bp')
        if (result.success) {
          showStatus('æœ¬åœ°BPçª—å£å·²æ‰“å¼€', 'success')
        } else {
          showStatus(`æ‰“å¼€å¤±è´¥: ${result.error}`, 'error')
        }
      } catch (error) {
        showStatus(`æ‰“å¼€å¤±è´¥: ${error.message}`, 'error')
      }
    })

    const TEAM_MANAGER_KEY = 'asg_team_manager_teams'
    const TEAM_MANAGER_SELECTION_KEY = 'asg_team_manager_selection'
    let teamManagerTeams = []

    const teamCsvInput = document.getElementById('teamCsvInput')
    const importTeamCsvBtn = document.getElementById('importTeamCsvBtn')
    const teamManagerClearBtn = document.getElementById('teamManagerClearBtn')
    const teamManagerCount = document.getElementById('teamManagerCount')
    const teamManagerTeamA = document.getElementById('teamManagerTeamA')
    const teamManagerTeamB = document.getElementById('teamManagerTeamB')
    const teamManagerPreviewA = document.getElementById('teamManagerPreviewA')
    const teamManagerPreviewB = document.getElementById('teamManagerPreviewB')
    const applyTeamsToLocalBpBtn = document.getElementById('applyTeamsToLocalBpBtn')

    function loadTeamManagerData() {
      try {
        const raw = localStorage.getItem(TEAM_MANAGER_KEY)
        teamManagerTeams = raw ? JSON.parse(raw) : []
      } catch (e) {
        teamManagerTeams = []
      }
    }

    function saveTeamManagerData() {
      localStorage.setItem(TEAM_MANAGER_KEY, JSON.stringify(teamManagerTeams))
    }

    function loadTeamManagerSelection() {
      try {
        const raw = localStorage.getItem(TEAM_MANAGER_SELECTION_KEY)
        return raw ? JSON.parse(raw) : {}
      } catch {
        return {}
      }
    }

    function saveTeamManagerSelection(sel) {
      localStorage.setItem(TEAM_MANAGER_SELECTION_KEY, JSON.stringify(sel || {}))
    }

    function parseCsvRows(text) {
      const rows = []
      let row = []
      let field = ''
      let inQuotes = false
      for (let i = 0; i < text.length; i++) {
        const ch = text[i]
        const next = text[i + 1]
        if (ch === '"') {
          if (inQuotes && next === '"') {
            field += '"'
            i++
          } else {
            inQuotes = !inQuotes
          }
          continue
        }
        if (!inQuotes && (ch === '\n' || ch === '\r')) {
          if (ch === '\r' && next === '\n') i++
          row.push(field)
          rows.push(row)
          row = []
          field = ''
          continue
        }
        if (!inQuotes && ch === ',') {
          row.push(field)
          field = ''
          continue
        }
        field += ch
      }
      if (field.length > 0 || row.length > 0) {
        row.push(field)
        rows.push(row)
      }
      return rows.map(r => r.map(v => (v || '').trim())).filter(r => r.some(v => v !== ''))
    }

    function normalizeHeader(h) {
      return (h || '').replace('\uFEFF', '').trim().toLowerCase()
    }

    function parseTeamsFromCsv(text) {
      const rows = parseCsvRows(text)
      if (rows.length <= 1) return []
      const header = rows[0].map(normalizeHeader)
      const idx = {
        teamName: header.findIndex(h => h === 'teamname'),
        teamId: header.findIndex(h => h === 'teamid'),
        qq: header.findIndex(h => h === 'qqnumber'),
        playerName: header.findIndex(h => h === 'playername'),
        gameId: header.findIndex(h => h === 'gameid'),
        gameRank: header.findIndex(h => h === 'gamerank'),
        playerDesc: header.findIndex(h => h === 'playerdescription')
      }
      const map = new Map()
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i]
        const teamName = idx.teamName >= 0 ? row[idx.teamName] : ''
        const teamId = idx.teamId >= 0 ? row[idx.teamId] : ''
        if (!teamName && !teamId) continue
        const key = teamId || teamName
        if (!map.has(key)) {
          map.set(key, {
            id: teamId,
            name: teamName || teamId,
            qq: idx.qq >= 0 ? row[idx.qq] : '',
            players: []
          })
        }
        const team = map.get(key)
        const playerName = idx.playerName >= 0 ? row[idx.playerName] : ''
        const gameId = idx.gameId >= 0 ? row[idx.gameId] : ''
        const gameRank = idx.gameRank >= 0 ? row[idx.gameRank] : ''
        const playerDescription = idx.playerDesc >= 0 ? row[idx.playerDesc] : ''
        if (playerName || gameId) {
          const exists = team.players.some(p => (p.name || '') === playerName && (p.gameId || '') === gameId)
          if (!exists) {
            team.players.push({ name: playerName, gameId, gameRank, description: playerDescription })
          }
        }
      }
      return Array.from(map.values()).sort((a, b) => String(a.name).localeCompare(String(b.name), 'zh-CN'))
    }

    function renderTeamManager() {
      if (teamManagerCount) {
        teamManagerCount.textContent = teamManagerTeams.length ? `å·²å¯¼å…¥ ${teamManagerTeams.length} æ”¯é˜Ÿä¼` : 'æœªå¯¼å…¥'
      }
      const selection = loadTeamManagerSelection()
      const buildOptions = (selectEl, selectedId) => {
        if (!selectEl) return
        const options = ['<option value="">è¯·é€‰æ‹©</option>'].concat(teamManagerTeams.map(t => {
          const val = t.id || t.name
          const label = t.name + (t.id ? ` (${t.id.slice(0, 6)}...)` : '')
          return `<option value="${val}">${label}</option>`
        }))
        selectEl.innerHTML = options.join('')
        if (selectedId) selectEl.value = selectedId
      }
      buildOptions(teamManagerTeamA, selection.teamA || '')
      buildOptions(teamManagerTeamB, selection.teamB || '')
      updateTeamPreview()
    }

    function findTeamById(val) {
      if (!val) return null
      return teamManagerTeams.find(t => (t.id || t.name) === val) || null
    }

    function renderPreview(el, team) {
      if (!el) return
      if (!team) {
        el.textContent = ''
        return
      }
      const players = team.players || []
      const list = players.map(p => p.name || p.gameId).filter(Boolean)
      el.textContent = list.length ? `é˜µå®¹ï¼š${list.join('ã€')}` : 'æœªè¯†åˆ«é€‰æ‰‹'
    }

    function updateTeamPreview() {
      const teamA = findTeamById(teamManagerTeamA?.value)
      const teamB = findTeamById(teamManagerTeamB?.value)
      renderPreview(teamManagerPreviewA, teamA)
      renderPreview(teamManagerPreviewB, teamB)
      saveTeamManagerSelection({ teamA: teamManagerTeamA?.value || '', teamB: teamManagerTeamB?.value || '' })
    }

    async function importTeamCsv() {
      const file = teamCsvInput?.files?.[0]
      if (!file) {
        showStatus('è¯·é€‰æ‹©CSVæ–‡ä»¶', 'warning')
        return
      }
      try {
        const text = await file.text()
        const teams = parseTeamsFromCsv(text)
        if (!teams.length) {
          showStatus('CSVæœªè§£æåˆ°é˜Ÿä¼æ•°æ®', 'warning')
          return
        }
        teamManagerTeams = teams
        saveTeamManagerData()
        renderTeamManager()
        showStatus(`å·²å¯¼å…¥ ${teams.length} æ”¯é˜Ÿä¼`, 'success')
      } catch (e) {
        showStatus('å¯¼å…¥å¤±è´¥: ' + (e?.message || e), 'error')
      }
    }

    function applyTeamsToLocalBp() {
      const teamA = findTeamById(teamManagerTeamA?.value)
      const teamB = findTeamById(teamManagerTeamB?.value)
      if (!teamA && !teamB) {
        showStatus('è¯·é€‰æ‹©è‡³å°‘ä¸€æ”¯é˜Ÿä¼', 'warning')
        return
      }
      let matchBase = {}
      try {
        matchBase = JSON.parse(localStorage.getItem('localBp_matchBase') || '{}')
      } catch { }
      if (!matchBase.teamA) matchBase.teamA = { name: '', roster: [] }
      if (!matchBase.teamB) matchBase.teamB = { name: '', roster: [] }
      if (teamA) {
        matchBase.teamA.name = teamA.name || matchBase.teamA.name
        const rosterA = (teamA.players || []).map(p => p.name || p.gameId).filter(Boolean)
        if (rosterA.length) matchBase.teamA.roster = rosterA
      }
      if (teamB) {
        matchBase.teamB.name = teamB.name || matchBase.teamB.name
        const rosterB = (teamB.players || []).map(p => p.name || p.gameId).filter(Boolean)
        if (rosterB.length) matchBase.teamB.roster = rosterB
      }
      localStorage.setItem('localBp_matchBase', JSON.stringify(matchBase))
      window.dispatchEvent(new Event('storage'))
      window.dispatchEvent(new CustomEvent('local-bp-update'))
      showStatus('å·²åº”ç”¨åˆ°æœ¬åœ°BP', 'success')
    }

    function clearTeamManager() {
      teamManagerTeams = []
      saveTeamManagerData()
      renderTeamManager()
    }

    importTeamCsvBtn?.addEventListener('click', importTeamCsv)
    teamManagerClearBtn?.addEventListener('click', clearTeamManager)
    teamManagerTeamA?.addEventListener('change', updateTeamPreview)
    teamManagerTeamB?.addEventListener('change', updateTeamPreview)
    applyTeamsToLocalBpBtn?.addEventListener('click', applyTeamsToLocalBp)

    loadTeamManagerData()
    renderTeamManager()

    // å‰å° 3D æ¨¡å‹è®¾ç½®å¿«æ·å…¥å£
    const openModelSettingsBtn = document.getElementById('openModelSettingsBtn')
    openModelSettingsBtn?.addEventListener('click', async () => {
      try {
        const card = document.getElementById('model3dSettingsCard')
        if (card && card.classList.contains('collapsed')) {
          setModel3dCardCollapsed(false)
        }
        card?.scrollIntoView({ behavior: 'smooth', block: 'start' })
        showStatus('å·²å®šä½åˆ°â€œå‰å° 3Dæ¨¡å‹è®¾ç½®â€', 'info')
      } catch (error) {
        showStatus(`æ‰“å¼€å¤±è´¥: ${error.message}`, 'error')
      }
    })

    // ==================== 3D æ¨¡å‹è®¾ç½®ï¼ˆä¸»é¡µï¼‰ ====================
    let __model3dApplyTimer = null
    const MODEL3D_CARD_STATE_KEY = 'homepageModel3dCardCollapsed'

    function getDefaultModel3dConfig() {
      return {
        enabled: false,
        targetFPS: 30,
        survivorModelDir: null,
        hunterModelDir: null,
        survivorMotionDir: null,
        hunterMotionDir: null,
        defaultMotionVmd: null,

        // æ¸²æŸ“è´¨é‡
        antialias: true,
        pixelRatio: 1,
        enableShadows: false,
        shadowQuality: 1024,

        // é£æ ¼åŒ–æ¸²æŸ“
        enableOutline: true,
        outlineThickness: 0.003,
        outlineColor: '#000000',
        outlineAlpha: 1.0,
        enableToon: false,
        toonGradient: 5,

        // å…‰ç…§
        ambientColor: '#ffffff',
        ambientIntensity: 0.5,
        directionalColor: '#ffffff',
        directionalIntensity: 0.7,
        lightPosX: 10,
        lightPosY: 20,
        lightPosZ: 10,

        // 3D è§†å£ï¼ˆå‰å°ä¿å­˜çš„é«˜çº§è®¾ç½®ï¼‰
        viewports: {}
      }
    }

    function bindModel3dAutoApply() {
      const auto = document.getElementById('model3dAutoApply')
      const ids = [
        'enable3dModels',
        'model3dTargetFPS',
        'survivorModelDir',
        'hunterModelDir',
        'survivorMotionDir',
        'hunterMotionDir',
        'defaultMotionVmd',
        'render3dAntialias',
        'render3dPixelRatio',
        'render3dEnableShadows',
        'render3dShadowQuality',
        'render3dEnableOutline',
        'render3dOutlineThickness',
        'render3dOutlineColor',
        'render3dOutlineAlpha',
        'render3dEnableToon',
        'render3dToonGradient',
        'render3dAmbientColor',
        'render3dAmbientIntensity',
        'render3dDirectionalColor',
        'render3dDirectionalIntensity',
        'render3dLightPosX',
        'render3dLightPosY',
        'render3dLightPosZ'
      ]

      const handler = () => {
        if (!auto?.checked) return
        if (__model3dApplyTimer) clearTimeout(__model3dApplyTimer)
        __model3dApplyTimer = setTimeout(() => applyModel3dSettings(false), 450)
      }

      for (const id of ids) {
        const el = document.getElementById(id)
        if (!el) continue
        el.addEventListener('change', handler)
        el.addEventListener('input', handler)
      }
    }

    async function pickFolderFor(inputId) {
      try {
        const res = await window.electronAPI.selectFolder()
        if (res && res.success && res.path) {
          const el = document.getElementById(inputId)
          if (el) el.value = res.path
          const auto = document.getElementById('model3dAutoApply')
          if (auto?.checked) applyModel3dSettings(false)
        }
      } catch (e) {
        showStatus('é€‰æ‹©æ–‡ä»¶å¤¹å¤±è´¥: ' + (e?.message || e), 'error')
      }
    }

    async function pickVmdFor(inputId) {
      try {
        const res = await window.electronAPI.selectFileWithFilter({
          filters: [{ name: 'VMD åŠ¨ä½œæ–‡ä»¶', extensions: ['vmd'] }, { name: 'æ‰€æœ‰æ–‡ä»¶', extensions: ['*'] }]
        })
        if (res && res.success && res.path) {
          const el = document.getElementById(inputId)
          if (el) el.value = res.path
          const auto = document.getElementById('model3dAutoApply')
          if (auto?.checked) applyModel3dSettings(false)
        }
      } catch (e) {
        showStatus('é€‰æ‹©æ–‡ä»¶å¤±è´¥: ' + (e?.message || e), 'error')
      }
    }

    function __setVal(id, v) {
      const el = document.getElementById(id)
      if (!el) return
      if (el.type === 'checkbox') {
        el.checked = !!v
        return
      }
      el.value = (v ?? '')
    }

    async function loadModel3dSettings() {
      try {
        const result = await window.electronAPI.loadLayout()
        const layout = (result && result.success && result.layout) ? result.layout : {}
        const def = getDefaultModel3dConfig()
        const m0 = (layout && layout.model3d && typeof layout.model3d === 'object') ? layout.model3d : {}
        const m = { ...def, ...m0, viewports: (m0 && m0.viewports) ? m0.viewports : {} }

        __setVal('enable3dModels', !!m.enabled)
        __setVal('model3dTargetFPS', Number(m.targetFPS || 30))
        __setVal('survivorModelDir', m.survivorModelDir || '')
        __setVal('hunterModelDir', m.hunterModelDir || '')
        __setVal('survivorMotionDir', m.survivorMotionDir || '')
        __setVal('hunterMotionDir', m.hunterMotionDir || '')
        __setVal('defaultMotionVmd', m.defaultMotionVmd || '')

        __setVal('render3dAntialias', String(m.antialias !== false))
        __setVal('render3dPixelRatio', String(Number(m.pixelRatio ?? 1)))
        __setVal('render3dEnableShadows', !!m.enableShadows)
        __setVal('render3dShadowQuality', String(Number(m.shadowQuality || 1024)))

        __setVal('render3dEnableOutline', m.enableOutline !== false)
        __setVal('render3dOutlineThickness', String(Number(m.outlineThickness || 0.003)))
        __setVal('render3dOutlineColor', m.outlineColor || '#000000')
        __setVal('render3dOutlineAlpha', String(Number(m.outlineAlpha ?? 1.0)))
        __setVal('render3dEnableToon', !!m.enableToon)
        __setVal('render3dToonGradient', String(Number(m.toonGradient || 5)))

        __setVal('render3dAmbientColor', m.ambientColor || '#ffffff')
        __setVal('render3dAmbientIntensity', String(Number(m.ambientIntensity ?? 0.5)))
        __setVal('render3dDirectionalColor', m.directionalColor || '#ffffff')
        __setVal('render3dDirectionalIntensity', String(Number(m.directionalIntensity ?? 0.7)))
        __setVal('render3dLightPosX', String(Number(m.lightPosX ?? 10)))
        __setVal('render3dLightPosY', String(Number(m.lightPosY ?? 20)))
        __setVal('render3dLightPosZ', String(Number(m.lightPosZ ?? 10)))

        showStatus('å·²è¯»å– 3D æ¨¡å‹é…ç½®', 'success')
      } catch (e) {
        console.error('è¯»å– 3D æ¨¡å‹é…ç½®å¤±è´¥:', e)
        showStatus('è¯»å–å¤±è´¥: ' + (e?.message || e), 'error')
      }
    }

    async function applyModel3dSettings(showToast) {
      try {
        const result = await window.electronAPI.loadLayout()
        const layout = (result && result.success && result.layout) ? result.layout : {}
        const def = getDefaultModel3dConfig()
        const prev = (layout && layout.model3d && typeof layout.model3d === 'object') ? layout.model3d : {}

        const m = {
          enabled: !!document.getElementById('enable3dModels')?.checked,
          targetFPS: Number(document.getElementById('model3dTargetFPS')?.value) || def.targetFPS,
          survivorModelDir: document.getElementById('survivorModelDir')?.value || null,
          hunterModelDir: document.getElementById('hunterModelDir')?.value || null,
          survivorMotionDir: document.getElementById('survivorMotionDir')?.value || null,
          hunterMotionDir: document.getElementById('hunterMotionDir')?.value || null,
          defaultMotionVmd: document.getElementById('defaultMotionVmd')?.value || null,

          antialias: document.getElementById('render3dAntialias')?.value === 'true',
          pixelRatio: Number(document.getElementById('render3dPixelRatio')?.value) || def.pixelRatio,
          enableShadows: !!document.getElementById('render3dEnableShadows')?.checked,
          shadowQuality: Number(document.getElementById('render3dShadowQuality')?.value) || def.shadowQuality,

          enableOutline: document.getElementById('render3dEnableOutline')?.checked !== false,
          outlineThickness: Number(document.getElementById('render3dOutlineThickness')?.value) || def.outlineThickness,
          outlineColor: document.getElementById('render3dOutlineColor')?.value || def.outlineColor,
          outlineAlpha: Number(document.getElementById('render3dOutlineAlpha')?.value ?? def.outlineAlpha),
          enableToon: !!document.getElementById('render3dEnableToon')?.checked,
          toonGradient: Number(document.getElementById('render3dToonGradient')?.value) || def.toonGradient,

          ambientColor: document.getElementById('render3dAmbientColor')?.value || def.ambientColor,
          ambientIntensity: Number(document.getElementById('render3dAmbientIntensity')?.value ?? def.ambientIntensity),
          directionalColor: document.getElementById('render3dDirectionalColor')?.value || def.directionalColor,
          directionalIntensity: Number(document.getElementById('render3dDirectionalIntensity')?.value ?? def.directionalIntensity),
          lightPosX: Number(document.getElementById('render3dLightPosX')?.value ?? def.lightPosX),
          lightPosY: Number(document.getElementById('render3dLightPosY')?.value ?? def.lightPosY),
          lightPosZ: Number(document.getElementById('render3dLightPosZ')?.value ?? def.lightPosZ),

          viewports: prev.viewports ? prev.viewports : {}
        }

        layout.model3d = m

        const saveRes = await window.electronAPI.saveLayout(layout)
        if (!saveRes || !saveRes.success) {
          throw new Error(saveRes?.error || 'ä¿å­˜å¤±è´¥')
        }

        // è®©å‰å°åˆ·æ–°å¸ƒå±€ï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰
        try {
          if (window.electronAPI && window.electronAPI.sendToFrontend) {
            window.electronAPI.sendToFrontend({ type: 'layout-updated' })
          }
        } catch { }

        if (showToast) showStatus('âœ… 3D æ¨¡å‹è®¾ç½®å·²ä¿å­˜å¹¶åŒæ­¥åˆ°å‰å°', 'success')
      } catch (e) {
        console.error('ä¿å­˜ 3D æ¨¡å‹é…ç½®å¤±è´¥:', e)
        showStatus('ä¿å­˜å¤±è´¥: ' + (e?.message || e), 'error')
      }
    }

    function setModel3dCardCollapsed(collapsed, options = {}) {
      const card = document.getElementById('model3dSettingsCard')
      if (!card) return
      card.classList.toggle('collapsed', collapsed)
      const toggle = document.getElementById('model3dToggleBtn')
      if (toggle) {
        toggle.setAttribute('aria-expanded', String(!collapsed))
        const label = toggle.querySelector('.toggle-label')
        const icon = toggle.querySelector('.toggle-icon')
        if (label) label.textContent = collapsed ? 'å±•å¼€' : 'æ”¶èµ·'
        if (icon) icon.textContent = collapsed ? 'â–¸' : 'â–¾'
      }
      if (options.persist !== false && typeof localStorage !== 'undefined') {
        try {
          localStorage.setItem(MODEL3D_CARD_STATE_KEY, collapsed ? '1' : '0')
        } catch { }
      }
    }

    function toggleModel3dCard() {
      const card = document.getElementById('model3dSettingsCard')
      if (!card) return
      setModel3dCardCollapsed(!card.classList.contains('collapsed'))
    }

    function initModel3dCardToggle() {
      const toggle = document.getElementById('model3dToggleBtn')
      if (!toggle) return
      toggle.addEventListener('click', toggleModel3dCard)
    }

    function restoreModel3dCardState() {
      if (typeof localStorage === 'undefined') return
      const stored = localStorage.getItem(MODEL3D_CARD_STATE_KEY)
      // é»˜è®¤æŠ˜å ï¼šä»…å½“ç”¨æˆ·æ›¾ç»æ‰‹åŠ¨å±•å¼€ï¼ˆå­˜äº† 0ï¼‰æ‰å±•å¼€
      const collapsed = stored == null ? true : stored === '1'
      setModel3dCardCollapsed(collapsed, { persist: false })
    }

    // ==================== æ›´æ–°æ£€æŸ¥åŠŸèƒ½ ====================
    let isCheckingUpdate = false
    let hasAvailableUpdate = false

    // åˆå§‹åŒ–ç‰ˆæœ¬æ˜¾ç¤º
    async function initVersionDisplay() {
      try {
        const version = await window.electronAPI.getAppVersion()
        const versionBadge = document.getElementById('versionBadge')
        if (versionBadge) {
          versionBadge.textContent = `v${version}`
          versionBadge.title = 'ç‚¹å‡»æ£€æŸ¥æ›´æ–°'
        }
      } catch (e) {
        console.error('è·å–ç‰ˆæœ¬å¤±è´¥:', e)
      }
    }

    // æ£€æŸ¥æ›´æ–°
    async function checkUpdate() {
      if (isCheckingUpdate) return

      const updateBtn = document.getElementById('updateBtn')
      const versionBadge = document.getElementById('versionBadge')

      isCheckingUpdate = true
      updateBtn.classList.add('checking')
      updateBtn.querySelector('.update-text').textContent = 'æ£€æŸ¥ä¸­...'

      try {
        await window.electronAPI.manualCheckUpdate()
        showStatus('å·²æ£€æŸ¥æ›´æ–°', 'info')
      } catch (e) {
        console.error('æ£€æŸ¥æ›´æ–°å¤±è´¥:', e)
        showStatus('æ£€æŸ¥æ›´æ–°å¤±è´¥: ' + e.message, 'error')
      } finally {
        isCheckingUpdate = false
        updateBtn.classList.remove('checking')
        updateBtn.querySelector('.update-text').textContent = 'æ£€æŸ¥æ›´æ–°'
      }
    }

    // é™é»˜æ£€æŸ¥æ›´æ–°ï¼ˆå¯åŠ¨æ—¶ï¼‰
    async function silentCheckUpdate() {
      try {
        const result = await window.electronAPI.checkForUpdate()
        if (result.success && result.data && result.data.hasUpdate) {
          hasAvailableUpdate = true
          const updateBtn = document.getElementById('updateBtn')
          const versionBadge = document.getElementById('versionBadge')

          updateBtn.classList.add('has-update')
          updateBtn.querySelector('.update-text').textContent = 'æœ‰æ–°ç‰ˆæœ¬'
          versionBadge.classList.add('has-update')
          versionBadge.title = `å‘ç°æ–°ç‰ˆæœ¬ ${result.data.latestVersion}ï¼Œç‚¹å‡»æ›´æ–°`
        }
      } catch (e) {
        console.error('é™é»˜æ£€æŸ¥æ›´æ–°å¤±è´¥:', e)
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€å’Œæˆ¿é—´å†å²
    if (window.electronAPI && window.electronAPI.on) {
      window.electronAPI.on('auth-expired', (data) => {
        try {
          currentUser = null
          myEvents = []
          updateUserUI()
          renderPredictionSection()
          if (data && data.reason === 'logout') {
            // æ­£å¸¸æ‰‹åŠ¨é€€å‡ºï¼Œä¸å¼¹çª—
            return
          }
          showStatus('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'warning')
          showLoginModal('æ‚¨çš„ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•ä»¥ç»§ç»­ä½¿ç”¨ç«çŒœä¸åŒæ­¥åŠŸèƒ½ã€‚')
        } catch (e) {
          console.warn('auth-expired handler error', e)
        }
      })
    }

    checkAuthStatus()
    loadRoomHistory()
    initVersionDisplay()
    loadFrontendResolution()
    loadTransparentBackgroundSetting()

    // åŠ è½½æ’ä»¶ç»„ä»¶
    loadPluginComponents()
    restoreModel3dCardState()
    initModel3dCardToggle()
    loadModel3dSettings()
    bindModel3dAutoApply()

    // å»¶è¿Ÿé™é»˜æ£€æŸ¥æ›´æ–°
    setTimeout(silentCheckUpdate, 3000)

    // ==================== æ’ä»¶ç³»ç»Ÿé›†æˆ ====================

    // å½“å‰æ˜¾ç¤ºçš„é¡µé¢
    let currentPage = 'home'

    // æ˜¾ç¤ºæŒ‡å®šé¡µé¢
    // æ˜¾ç¤ºæŒ‡å®šé¡µé¢
    function showPage(pageId) {
      currentPage = pageId

      // deselect standard nav items
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'))

      // Update menu items state
      document.querySelectorAll('.plugin-menu-item').forEach(item => {
        item.classList.toggle('active', item.dataset.page === pageId)
      })

      // åˆ‡æ¢é¡µé¢æ˜¾ç¤º
      const mainContainer = document.getElementById('mainContainer')
      const pagesContainer = document.getElementById('pluginPagesContainer')

      if (pageId === 'home') {
        switchView('home')
      } else {
        mainContainer.classList.add('hidden')
        document.querySelectorAll('.plugin-page-container').forEach(p => {
          p.classList.toggle('active', p.dataset.pageId === pageId)
        })
      }
    }

    // æ’ä»¶è¯·æ±‚æ‰“å¼€æŸä¸ªæ’ä»¶é¡µé¢ï¼ˆç”±æ’ä»¶é€šè¿‡ api.ipc.send/broadcast è§¦å‘ï¼‰
    if (!window._pluginOpenPageListenerAdded && window.electronAPI && typeof window.electronAPI.on === 'function') {
      window._pluginOpenPageListenerAdded = true
      window.electronAPI.on('plugin:open-page', async (pageId) => {
        if (typeof pageId !== 'string' || !pageId) return
        console.log('[Main] open plugin page:', pageId)
        try {
          // å…ˆåˆ·æ–°ç»„ä»¶ï¼Œç¡®ä¿ç›®æ ‡é¡µé¢å·²æ¸²æŸ“åˆ° DOM
          await loadPluginComponents()
        } catch {
          // ignore
        }
        // ä¸‹ä¸€å¸§å†åˆ‡æ¢ï¼Œé¿å…ä¸ DOM æ›´æ–°ç«äº‰
        setTimeout(() => showPage(pageId), 0)
      })
    }

    // åŠ è½½æ’ä»¶ç»„ä»¶ï¼ˆå¡ç‰‡ã€é¡µé¢ã€èœå•é¡¹ï¼‰
    async function loadPluginComponents() {
      try {
        if (!window.plugins) {
          console.log('[Main] æ’ä»¶ API æœªå°±ç»ªï¼Œç¨åé‡è¯•...')
          setTimeout(loadPluginComponents, 1000)
          return
        }

        // åŠ è½½æ’ä»¶å¡ç‰‡
        const cards = await window.plugins.getPluginCards()
        renderPluginCards(cards)

        // åŠ è½½æ’ä»¶èœå•é¡¹
        const menuItems = await window.plugins.getPluginMenuItems()
        renderPluginMenuItems(menuItems)

        // åŠ è½½æ’ä»¶é¡µé¢
        const pages = await window.plugins.getPluginPages()
        renderPluginPages(pages)

        console.log(`[Main] å·²åŠ è½½ ${cards.length} ä¸ªæ’ä»¶å¡ç‰‡, ${menuItems.length} ä¸ªèœå•é¡¹, ${pages.length} ä¸ªé¡µé¢`)

        // ç›‘å¬ç»„ä»¶å˜åŒ–äº‹ä»¶ï¼ˆåªç›‘å¬ä¸€æ¬¡ï¼‰
        if (!window._pluginComponentsListenerAdded && window.plugins.onComponentsChanged) {
          window._pluginComponentsListenerAdded = true
          window.plugins.onComponentsChanged(() => {
            console.log('[Main] æ’ä»¶ç»„ä»¶å·²å˜åŒ–ï¼Œé‡æ–°åŠ è½½...')
            loadPluginComponents()
          })
        }
      } catch (e) {
        console.error('[Main] åŠ è½½æ’ä»¶ç»„ä»¶å¤±è´¥:', e)
        // ç¨åé‡è¯•
        setTimeout(loadPluginComponents, 2000)
      }
    }

    // æ¸²æŸ“æ’ä»¶å¡ç‰‡
    function renderPluginCards(cards) {
      const section = document.getElementById('pluginCardsSection')
      const grid = document.getElementById('pluginCardsGrid')

      // æ‰§è¡Œå®¹å™¨å†…çš„è„šæœ¬ï¼ˆinnerHTML æ’å…¥çš„ script é»˜è®¤ä¸ä¼šæ‰§è¡Œï¼‰
      function runScriptsWithin(root) {
        if (!root) return
        const scripts = root.querySelectorAll('script')
        scripts.forEach(oldScript => {
          try {
            const newScript = document.createElement('script')
            // å¤åˆ¶å±æ€§ï¼ˆtype/src ç­‰ï¼‰
            for (const attr of Array.from(oldScript.attributes || [])) {
              newScript.setAttribute(attr.name, attr.value)
            }
            newScript.text = oldScript.textContent || ''
            oldScript.parentNode && oldScript.parentNode.replaceChild(newScript, oldScript)
          } catch (e) {
            console.warn('[Main] runScriptsWithin failed:', e && e.message ? e.message : e)
          }
        })
      }

      if (!cards || cards.length === 0) {
        section.style.display = 'none'
        return
      }

      section.style.display = 'block'
      grid.innerHTML = cards.map(card => `
        <div class="plugin-card" data-card-id="${card.id}">
          <div class="plugin-card-header">
            <div class="plugin-card-icon ${card.iconColor || 'blue'}">${card.icon || 'ğŸ§©'}</div>
            <div>
              <div class="plugin-card-title">${card.title}</div>
              <div class="plugin-card-desc">${card.description || ''}</div>
            </div>
          </div>
          <div class="plugin-card-content">
            ${card.html || ''}
          </div>
          ${card.actions && card.actions.length > 0 ? `
            <div class="plugin-card-actions">
              ${card.actions.map(action => `
                <button class="plugin-card-action" onclick="executeCardAction('${card.id}', '${action.id}')">${action.icon || ''} ${action.label}</button>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `).join('')

      // è®©å¡ç‰‡å†…è”è„šæœ¬ç”Ÿæ•ˆï¼ˆç”¨äºæ’ä»¶äº¤äº’ UIï¼‰
      runScriptsWithin(grid)
    }

    // æ¸²æŸ“æ’ä»¶èœå•é¡¹
    function renderPluginMenuItems(menuItems) {
      const menubar = document.getElementById('pluginMenubar')

      if (!menubar) return

      // ç§»é™¤æ—§çš„æ’ä»¶èœå•é¡¹å’Œåˆ†éš”çº¿
      menubar.querySelectorAll('[data-plugin-menu-item], .plugin-menu-divider').forEach(el => el.remove())

      if (!menuItems || menuItems.length === 0) return

      // æ·»åŠ åˆ†éš”çº¿
      const divider = document.createElement('div')
      divider.className = 'plugin-menu-divider'
      menubar.appendChild(divider)

      // æ·»åŠ èœå•é¡¹
      menuItems.forEach(item => {
        const btn = document.createElement('button')
        btn.className = 'plugin-menu-item'
        btn.dataset.page = item.pageId || item.id
        btn.dataset.pluginMenuItem = 'true'
        btn.innerHTML = `
          <span class="plugin-menu-icon">${item.icon || 'ğŸ“„'}</span>
          <span>${item.label}</span>
        `
        btn.onclick = () => {
          if (item.command) {
            window.plugins.executeCommand(item.command)
          } else if (item.pageId) {
            showPage(item.pageId)
          }
        }
        menubar.appendChild(btn)
      })
    }

    // æ¸²æŸ“æ’ä»¶é¡µé¢
    function renderPluginPages(pages) {
      const container = document.getElementById('pluginPagesContainer')

      if (!container) return

      // æ¸…é™¤æ—§çš„æ’ä»¶é¡µé¢
      container.querySelectorAll('.plugin-page-container').forEach(el => el.remove())

      if (!pages || pages.length === 0) return

      // æ‰§è¡Œå®¹å™¨å†…çš„è„šæœ¬ï¼ˆinnerHTML æ’å…¥çš„ script é»˜è®¤ä¸ä¼šæ‰§è¡Œï¼‰
      function runScriptsWithin(root) {
        if (!root) return
        const scripts = root.querySelectorAll('script')
        scripts.forEach(oldScript => {
          try {
            const newScript = document.createElement('script')
            for (const attr of Array.from(oldScript.attributes || [])) {
              newScript.setAttribute(attr.name, attr.value)
            }
            newScript.text = oldScript.textContent || ''
            oldScript.parentNode && oldScript.parentNode.replaceChild(newScript, oldScript)
          } catch (e) {
            console.warn('[Main] runScriptsWithin failed:', e && e.message ? e.message : e)
          }
        })
      }

      pages.forEach(page => {
        const pageDiv = document.createElement('div')
        pageDiv.className = 'plugin-page-container'
        pageDiv.dataset.pageId = page.id
        pageDiv.innerHTML = `
          <div style="max-width: 1400px; margin: 0 auto;">
            <h2 style="margin-bottom: 20px; color: var(--md-on-surface, #fff);">
              ${page.icon || 'ğŸ“„'} ${page.title}
            </h2>
            <div class="plugin-page-content">
              ${page.html || '<p>é¡µé¢å†…å®¹åŠ è½½ä¸­...</p>'}
            </div>
          </div>
        `
        container.appendChild(pageDiv)

        // è®©é¡µé¢è„šæœ¬ç”Ÿæ•ˆï¼ˆç”¨äºæ’ä»¶é¡µé¢çš„æŒ‰é’®/äº¤äº’ï¼‰
        runScriptsWithin(pageDiv)
      })
    }

    // æ‰§è¡Œå¡ç‰‡åŠ¨ä½œ
    async function executeCardAction(cardId, actionId) {
      try {
        const result = await window.plugins.cardAction(cardId, actionId)
        if (result && result.message) {
          showStatus(result.message, result.type || 'info')
        }
      } catch (e) {
        showStatus('æ‰§è¡Œå¤±è´¥: ' + e.message, 'error')
      }
    }

    // ========= å­—ä½“è®¾ç½®åŠŸèƒ½ (Font Settings) =========
    async function openFontSettings() {
      try {
        if (window.electronAPI && window.electronAPI.openFontSettings) {
          await window.electronAPI.openFontSettings()
        }
      } catch (e) {
        console.error('æ‰“å¼€å­—ä½“è®¾ç½®å¤±è´¥:', e)
        showStatus('æ‰“å¼€å­—ä½“è®¾ç½®å¤±è´¥: ' + e.message, 'error')
      }
    }

    async function openComponentEditor() {
      try {
        if (window.electronAPI && window.electronAPI.openComponentEditor) {
          await window.electronAPI.openComponentEditor()
        }
      } catch (e) {
        console.error('æ‰“å¼€ç»„ä»¶è®¾è®¡å™¨å¤±è´¥:', e)
        showStatus('æ‰“å¼€ç»„ä»¶è®¾è®¡å™¨å¤±è´¥: ' + e.message, 'error')
      }
    }

    async function openAnimationEditor() {
      try {
        if (window.electronAPI && window.electronAPI.openAnimationEditor) {
          await window.electronAPI.openAnimationEditor()
        }
      } catch (e) {
        console.error('æ‰“å¼€åŠ¨ç”»ç¼–è¾‘å™¨å¤±è´¥:', e)
        showStatus('æ‰“å¼€åŠ¨ç”»ç¼–è¾‘å™¨å¤±è´¥: ' + e.message, 'error')
      }
    }

    // ========= Idvevent èµ›ç¨‹å¯¼å…¥åŠŸèƒ½ =========

    // é…ç½®
    const IDVEVENT_CONFIG = {
      apiBaseUrl: 'https://api.idvevent.cn/api',
      asgApiBaseUrl: 'https://api.idvevent.cn/api' // å…¨éƒ¨ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒ
    }

    // å½“å‰ç”¨æˆ·çš„token
    async function getAuthToken() {
      try {
        // ä¼˜å…ˆä»ä¸»è¿›ç¨‹è·å–Token (å•ç‚¹ç™»å½•çŠ¶æ€)
        if (window.electronAPI && window.electronAPI.getAuthStatus) {
          const status = await window.electronAPI.getAuthStatus()
          if (status && status.token) {
            return status.token
          }
        }

        // é™çº§: ä»localStorageè·å– (è™½ç„¶ç°åœ¨ä¸»è¦ä¾èµ–ä¸»è¿›ç¨‹)
        const token = localStorage.getItem('authToken')
        return token || null
      } catch (e) {
        console.error('è·å–tokenå¤±è´¥:', e)
        return null
      }
    }

    // åŠ è½½Idveventèµ›ç¨‹åˆ—è¡¨
    async function loadIdveventSchedules() {
      const btn = document.getElementById('refreshScheduleBtn')
      const listContainer = document.getElementById('idveventScheduleList')
      const eventIdInput = document.getElementById('idveventEventId')

      if (!listContainer) return

      try {
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        if (btn) {
          btn.disabled = true
          btn.innerHTML = 'â³ åŠ è½½ä¸­...'
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        listContainer.innerHTML = `
          <div style="text-align:center; padding:40px; color:var(--text-secondary);">
            <div style="font-size:32px; margin-bottom:12px;">â³</div>
            <div>æ­£åœ¨åŠ è½½èµ›ç¨‹...</div>
          </div>
        `

        // æ„å»ºAPI URL
        const eventId = eventIdInput?.value?.trim()
        // ç”¨æˆ·è¦æ±‚: "è¿”å›çš„èµ›ç¨‹åº”è¯¥æ˜¯æ—¶é—´æœ€è¿‘çš„åä¸ªèµ›ç¨‹"
        // å°è¯•æ·»åŠ æ’åºå‚æ•° (å¦‚æœAPIæ”¯æŒ)ï¼ŒåŒæ—¶é™åˆ¶pageSizeä¸º10
        let apiUrl = `${IDVEVENT_CONFIG.apiBaseUrl}/matches?page=1&pageSize=10`
        if (eventId) {
          apiUrl += `&eventId=${encodeURIComponent(eventId)}`
        }

        // å‘èµ·è¯·æ±‚
        const response = await fetch(apiUrl, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        })

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`)
        }

        let matches = await response.json()

        // ç¡®ä¿æŒ‰æ—¶é—´å€’åºæ’åˆ— (æœ€è¿‘çš„åœ¨å‰é¢)
        if (Array.isArray(matches)) {
          matches.sort((a, b) => new Date(b.matchTime) - new Date(a.matchTime))
        }


        // æ¸²æŸ“èµ›ç¨‹åˆ—è¡¨
        renderIdveventSchedules(matches)

        showStatus(`âœ… æˆåŠŸåŠ è½½ ${matches.length || 0} åœºèµ›ç¨‹`, 'success')
      } catch (e) {
        console.error('åŠ è½½èµ›ç¨‹å¤±è´¥:', e)
        listContainer.innerHTML = `
          <div style="text-align:center; padding:40px; color:#ff6b6b;">
            <div style="font-size:32px; margin-bottom:12px;">âŒ</div>
            <div style="margin-bottom:8px;">åŠ è½½å¤±è´¥</div>
            <div style="font-size:12px; color:var(--text-secondary);">${e.message || e}</div>
          </div>
        `
        showStatus('åŠ è½½èµ›ç¨‹å¤±è´¥: ' + (e.message || e), 'error')
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        if (btn) {
          btn.disabled = false
          btn.innerHTML = 'ğŸ”„ åˆ·æ–°'
        }
      }
    }

    // æ¸²æŸ“èµ›ç¨‹åˆ—è¡¨
    function renderIdveventSchedules(matches) {
      const listContainer = document.getElementById('idveventScheduleList')
      if (!listContainer) return

      if (!matches || matches.length === 0) {
        listContainer.innerHTML = `
          <div style="text-align:center; padding:40px; color:var(--text-secondary);">
            <div style="font-size:32px; margin-bottom:12px;">ğŸ“­</div>
            <div>æš‚æ— èµ›ç¨‹æ•°æ®</div>
          </div>
        `
        return
      }

      listContainer.innerHTML = matches.map(match => {
        const matchTime = new Date(match.matchTime).toLocaleString('zh-CN')
        const eventName = match.eventName || 'æœªçŸ¥èµ›äº‹'
        const homeTeam = match.homeTeamName || 'é˜Ÿä¼A'
        const awayTeam = match.awayTeamName || 'é˜Ÿä¼B'
        const stage = match.stage || ''

        return `
          <div class="schedule-item" data-match-id="${match.id}">
            <div class="schedule-item-header">
              <div class="schedule-item-teams">${homeTeam} vs ${awayTeam}</div>
              <div class="schedule-item-time">${matchTime}</div>
            </div>
            <div class="schedule-item-info">
              <span>ğŸ† ${eventName}</span>
              ${stage ? `<span>ğŸ“ ${stage}</span>` : ''}
            </div>
            <div class="schedule-item-actions">
              <button class="btn btn-primary btn-sm" onclick="importMatchToASG('${match.id}')">
                ğŸ“¥ å¯¼å…¥å¯¹å±€ä¿¡æ¯
              </button>
              <button class="btn btn-secondary btn-sm" onclick="importTeamLogos('${match.id}')">
                ğŸ–¼ï¸ å¯¼å…¥é˜Ÿä¼Logo
              </button>
            </div>
          </div>
        `
      }).join('')
    }

    // å¯¼å…¥å¯¹å±€ä¿¡æ¯åˆ°ASG API
    async function importMatchToASG(matchId) {
      try {
        showStatus('â³ æ­£åœ¨å¯¼å…¥å¯¹å±€ä¿¡æ¯...', 'info')

        // 1. ä»idveventè·å–å¯¹å±€è¯¦æƒ…
        const matchResponse = await fetch(`${IDVEVENT_CONFIG.apiBaseUrl}/matches/${matchId}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        })

        if (!matchResponse.ok) {
          throw new Error('è·å–å¯¹å±€è¯¦æƒ…å¤±è´¥')
        }

        const match = await matchResponse.json()

        // 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
        const token = await getAuthToken()
        if (!token) {
          showStatus('âŒ è¯·å…ˆç™»å½•è´¦å·', 'error')
          return
        }

        // 3. å‡†å¤‡å¯¼å…¥æ•°æ®
        const createMatchDto = {
          homeTeamId: match.homeTeamId,
          awayTeamId: match.awayTeamId,
          matchTime: match.matchTime,
          eventId: match.eventId,
          liveLink: match.liveLink || null,
          customData: JSON.stringify({
            source: 'idvevent',
            originalId: match.id,
            stage: match.stage
          }),
          commentator: match.commentator || null,
          director: match.director || null,
          referee: match.referee || null
        }

        // 4. å¯¼å…¥åˆ°ASG API
        const importResponse = await fetch(`${IDVEVENT_CONFIG.asgApiBaseUrl}/matches`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(createMatchDto)
        })

        if (!importResponse.ok) {
          const errorData = await importResponse.json().catch(() => ({}))
          throw new Error(errorData.message || `å¯¼å…¥å¤±è´¥ (HTTP ${importResponse.status})`)
        }

        const result = await importResponse.json()
        showStatus(`âœ… æˆåŠŸå¯¼å…¥å¯¹å±€: ${match.homeTeamName} vs ${match.awayTeamName}`, 'success')

        console.log('å¯¼å…¥æˆåŠŸ:', result)

        // ========== æ–°å¢: åŒæ­¥åˆ°æœ¬åœ°BP (Local BP) ==========
        try {
          // 1. è¯»å–ç°æœ‰é…ç½®æˆ–åˆ›å»ºé»˜è®¤
          let matchBase = {}
          try {
            matchBase = JSON.parse(localStorage.getItem('localBp_matchBase') || '{}')
          } catch { }

          // ç¡®ä¿ç»“æ„å®Œæ•´
          if (!matchBase.teamA) matchBase.teamA = { name: '', members: [] }
          if (!matchBase.teamB) matchBase.teamB = { name: '', members: [] }

          // 2. æ›´æ–°é˜Ÿå
          matchBase.teamA.name = match.homeTeamName
          matchBase.teamB.name = match.awayTeamName

          // 3. ä¿å­˜å›localStorage
          localStorage.setItem('localBp_matchBase', JSON.stringify(matchBase))

          // 4. å°è¯•é€šçŸ¥UIæ›´æ–°
          // å¦‚æœæ˜¯åœ¨åŒä¸€ä¸ªwindowä¸‹
          if (typeof window.loadMatchBase === 'function') {
            window.loadMatchBase()
            if (typeof window.renderMatchBaseForm === 'function') window.renderMatchBaseForm()
          }
          // è§¦å‘storageäº‹ä»¶ä»¥é€šçŸ¥å…¶ä»–çª—å£
          window.dispatchEvent(new Event('storage'))

          // ä¸“é—¨çš„è‡ªå®šä¹‰äº‹ä»¶ï¼Œå¦‚æœé¡µé¢åœ¨åŒä¸€çª—å£ä½†ç›‘å¬ä¸åŒ
          window.dispatchEvent(new CustomEvent('local-bp-update'))

          showStatus('å·²åŒæ­¥åˆ°æœ¬åœ°BPé¢æ¿', 'success')
        } catch (e) {
          console.warn('åŒæ­¥åˆ°æœ¬åœ°BPå¤±è´¥:', e)
        }
        // ===============================================

      } catch (e) {
        console.error('å¯¼å…¥å¯¹å±€å¤±è´¥:', e)
        showStatus('âŒ å¯¼å…¥å¤±è´¥: ' + (e.message || e), 'error')
      }
    }

    // å¯¼å…¥é˜Ÿä¼Logo
    async function importTeamLogos(matchId) {
      try {
        showStatus('â³ æ­£åœ¨å¯¼å…¥é˜Ÿä¼Logo...', 'info')

        // 1. ä»idveventè·å–å¯¹å±€è¯¦æƒ…
        const matchResponse = await fetch(`${IDVEVENT_CONFIG.apiBaseUrl}/matches/${matchId}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        })

        if (!matchResponse.ok) {
          throw new Error('è·å–å¯¹å±€è¯¦æƒ…å¤±è´¥')
        }

        const match = await matchResponse.json()

        // 2. æ£€æŸ¥ç™»å½•çŠ¶æ€
        const token = await getAuthToken()
        if (!token) {
          showStatus('âŒ è¯·å…ˆç™»å½•è´¦å·', 'error')
          return
        }

        let successCount = 0
        let failCount = 0

        // 3. å¯¼å…¥ä¸»é˜ŸLogo
        if (match.homeTeamId) {
          try {
            await importSingleTeamLogo(match.homeTeamId, token)
            successCount++
          } catch (e) {
            console.error('å¯¼å…¥ä¸»é˜ŸLogoå¤±è´¥:', e)
            failCount++
          }
        }

        // 4. å¯¼å…¥å®¢é˜ŸLogo
        if (match.awayTeamId) {
          try {
            await importSingleTeamLogo(match.awayTeamId, token)
            successCount++
          } catch (e) {
            console.error('å¯¼å…¥å®¢é˜ŸLogoå¤±è´¥:', e)
            failCount++
          }
        }

        // 5. æ˜¾ç¤ºç»“æœ
        if (successCount > 0 && failCount === 0) {
          showStatus(`âœ… æˆåŠŸå¯¼å…¥ ${successCount} ä¸ªé˜Ÿä¼Logo`, 'success')
        } else if (successCount > 0) {
          showStatus(`âš ï¸ éƒ¨åˆ†æˆåŠŸ: ${successCount} ä¸ªæˆåŠŸ, ${failCount} ä¸ªå¤±è´¥`, 'warning')
        } else {
          showStatus('âŒ å¯¼å…¥é˜Ÿä¼Logoå¤±è´¥', 'error')
        }

        // ========== æ–°å¢: åŒæ­¥Logoåˆ°æœ¬åœ°BP ==========
        if (successCount > 0) {
          setTimeout(async () => {
            try {
              let matchBase = JSON.parse(localStorage.getItem('localBp_matchBase') || '{}')

              // é‡æ–°è·å–æœ€æ–°çš„é˜Ÿä¼ä¿¡æ¯ä»¥æ‹¿åˆ°Logo URL
              // æ³¨æ„: è¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨idveventçš„logoUrl, æˆ–è€…ASG APIè¿”å›çš„Url
              // ç”±äºimportSingleTeamLogoæ²¡æœ‰è¿”å›URL, æˆ‘ä»¬å†æ¬¡æŸ¥è¯¢æˆ–ç®€åŒ–å¤„ç†
              // ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬å†æ¬¡æŸ¥è¯¢ASG APIè·å–æœ€æ–°Logo(å¦‚æœæœ‰) æˆ–è€…ç›´æ¥ä½¿ç”¨Idveventçš„URL
              // è¿™é‡Œæˆ‘ä»¬ä¸ºäº†å®æ—¶æ€§ï¼Œç›´æ¥å†æ¬¡æŸ¥è¯¢Idveventè·å–URLå­˜å…¥æœ¬åœ° (æœ¬åœ°BPæ”¯æŒè¿œç¨‹URL)

              if (match.homeTeamId) {
                const t = await fetch(`${IDVEVENT_CONFIG.apiBaseUrl}/teams/${match.homeTeamId}`).then(r => r.json()).catch(() => null)
                if (t && t.logoUrl && matchBase.teamA) matchBase.teamA.logo = t.logoUrl
              }
              if (match.awayTeamId) {
                const t = await fetch(`${IDVEVENT_CONFIG.apiBaseUrl}/teams/${match.awayTeamId}`).then(r => r.json()).catch(() => null)
                if (t && t.logoUrl && matchBase.teamB) matchBase.teamB.logo = t.logoUrl
              }

              localStorage.setItem('localBp_matchBase', JSON.stringify(matchBase))

              if (typeof window.loadMatchBase === 'function') {
                window.loadMatchBase()
                if (typeof window.renderMatchBaseForm === 'function') window.renderMatchBaseForm()
              }
              window.dispatchEvent(new Event('storage'))
              window.dispatchEvent(new CustomEvent('local-bp-update'))

            } catch (e) { console.warn('åŒæ­¥Logoåˆ°æœ¬åœ°å¤±è´¥', e) }
          }, 500)
        }
        // ==========================================

      } catch (e) {
        console.error('å¯¼å…¥é˜Ÿä¼Logoå¤±è´¥:', e)
        showStatus('âŒ å¯¼å…¥å¤±è´¥: ' + (e.message || e), 'error')
      }
    }

    // å¯¼å…¥å•ä¸ªé˜Ÿä¼çš„Logo
    async function importSingleTeamLogo(teamId, token) {
      // 1. è·å–idveventçš„é˜Ÿä¼ä¿¡æ¯
      const teamResponse = await fetch(`${IDVEVENT_CONFIG.apiBaseUrl}/teams/${teamId}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      })

      if (!teamResponse.ok) {
        throw new Error('è·å–é˜Ÿä¼ä¿¡æ¯å¤±è´¥')
      }

      const team = await teamResponse.json()

      // 2. å¦‚æœæœ‰logoUrlï¼Œä¸‹è½½å¹¶ä¸Šä¼ åˆ°ASG API
      if (team.logoUrl) {
        // ä¸‹è½½Logo
        const logoResponse = await fetch(team.logoUrl)
        if (!logoResponse.ok) {
          throw new Error('ä¸‹è½½Logoå¤±è´¥')
        }

        const logoBlob = await logoResponse.blob()

        // å‡†å¤‡FormData
        const formData = new FormData()
        formData.append('logo', logoBlob, 'logo.png')

        // ä¸Šä¼ åˆ°ASG API
        const uploadResponse = await fetch(`${IDVEVENT_CONFIG.asgApiBaseUrl}/teams/${teamId}/logo`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        })

        if (!uploadResponse.ok) {
          throw new Error('ä¸Šä¼ Logoå¤±è´¥')
        }
      } else {
        throw new Error('é˜Ÿä¼æ²¡æœ‰Logo')
      }
    }
  </script>
</body>

</html>
