<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OBS BP 控制</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Microsoft YaHei", sans-serif;
      background: #0f141b;
      color: #e5e7eb;
    }
    .app {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .title {
      font-size: 16px;
      font-weight: 600;
    }
    .section {
      background: #151b24;
      border: 1px solid #1f2937;
      border-radius: 10px;
      padding: 10px;
    }
    .section h3 {
      margin: 0 0 8px 0;
      font-size: 13px;
      color: #cbd5f5;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .row:last-child { margin-bottom: 0; }
    .label {
      min-width: 40px;
      font-size: 12px;
      color: #94a3b8;
    }
    select, input[type="text"] {
      background: #0b0f15;
      color: #e5e7eb;
      border: 1px solid #1f2937;
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 12px;
      flex: 1;
    }
    button {
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    button.secondary { background: #334155; }
    button.ghost { background: transparent; border: 1px solid #1f2937; color: #cbd5f5; }
    button.active { border: 1px solid #3b82f6; color: #93c5fd; background: rgba(59, 130, 246, 0.15); }
    .slot {
      flex: 1;
      background: #0b0f15;
      border: 1px solid #1f2937;
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 12px;
      min-height: 28px;
      display: flex;
      align-items: center;
    }
    .quick-input {
      max-width: 140px;
    }
    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .tag {
      background: #1f2937;
      color: #e5e7eb;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .tag span { color: #93c5fd; }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 999;
    }
    .overlay.active { display: flex; }
    .picker {
      width: min(520px, 100%);
      background: #0f141b;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .picker-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
    }
    .picker-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 6px;
      max-height: 320px;
      overflow: auto;
      padding-right: 2px;
    }
    .picker-item {
      background: #111827;
      border: 1px solid #1f2937;
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 12px;
      text-align: center;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .picker-item:hover { border-color: #3b82f6; color: #93c5fd; }
    .split {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .muted { color: #94a3b8; font-size: 11px; }
    .reset-group {
      display: inline-flex;
      gap: 6px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">OBS BP 控制</div>
      <div class="reset-group">
        <button class="ghost" id="resetBtn">重置</button>
        <button class="ghost" id="resetKeepGlobalBtn">重置(保留全局)</button>
      </div>
    </div>

    <div class="section">
      <h3>地图选择</h3>
      <div class="row">
        <select id="mapSelect"></select>
        <button id="applyMapBtn">应用</button>
      </div>
    </div>

    <div class="section">
      <h3>求生者选择</h3>
      <div class="row">
        <div class="label">S1</div>
        <div class="slot" id="survivorSlot0">-</div>
        <input type="text" class="quick-input" data-quick="survivor" data-index="0" placeholder="拼音回车">
        <button class="secondary" data-pick="survivor" data-index="0">选择</button>
        <button class="ghost" data-clear="survivor" data-index="0">清空</button>
      </div>
      <div class="row">
        <div class="label">S2</div>
        <div class="slot" id="survivorSlot1">-</div>
        <input type="text" class="quick-input" data-quick="survivor" data-index="1" placeholder="拼音回车">
        <button class="secondary" data-pick="survivor" data-index="1">选择</button>
        <button class="ghost" data-clear="survivor" data-index="1">清空</button>
      </div>
      <div class="row">
        <div class="label">S3</div>
        <div class="slot" id="survivorSlot2">-</div>
        <input type="text" class="quick-input" data-quick="survivor" data-index="2" placeholder="拼音回车">
        <button class="secondary" data-pick="survivor" data-index="2">选择</button>
        <button class="ghost" data-clear="survivor" data-index="2">清空</button>
      </div>
      <div class="row">
        <div class="label">S4</div>
        <div class="slot" id="survivorSlot3">-</div>
        <input type="text" class="quick-input" data-quick="survivor" data-index="3" placeholder="拼音回车">
        <button class="secondary" data-pick="survivor" data-index="3">选择</button>
        <button class="ghost" data-clear="survivor" data-index="3">清空</button>
      </div>
    </div>

    <div class="section">
      <h3>监管者选择</h3>
      <div class="row">
        <div class="label">H</div>
        <div class="slot" id="hunterSlot">-</div>
        <input type="text" class="quick-input" data-quick="hunter" placeholder="拼音回车">
        <button class="secondary" data-pick="hunter">选择</button>
        <button class="ghost" data-clear="hunter">清空</button>
      </div>
    </div>

    <div class="section">
      <h3>禁用角色</h3>
      <div class="split">
        <div>
          <div class="row">
            <div class="label">Ban求生</div>
            <input type="text" class="quick-input" data-quick="ban-survivor" placeholder="回车添加">
            <button class="secondary" data-pick="ban-survivor">添加</button>
          </div>
          <div class="tag-list" id="banSurvivorList"></div>
        </div>
        <div>
          <div class="row">
            <div class="label">Ban监管</div>
            <input type="text" class="quick-input" data-quick="ban-hunter" placeholder="回车添加">
            <button class="secondary" data-pick="ban-hunter">添加</button>
          </div>
          <div class="tag-list" id="banHunterList"></div>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>全局禁用</h3>
      <div class="split">
        <div>
          <div class="row">
            <div class="label">全局求生</div>
            <input type="text" class="quick-input" data-quick="global-survivor" placeholder="回车添加">
            <button class="secondary" data-pick="global-survivor">添加</button>
          </div>
          <div class="tag-list" id="globalBanSurvivorList"></div>
        </div>
        <div>
          <div class="row">
            <div class="label">全局监管</div>
            <input type="text" class="quick-input" data-quick="global-hunter" placeholder="回车添加">
            <button class="secondary" data-pick="global-hunter">添加</button>
          </div>
          <div class="tag-list" id="globalBanHunterList"></div>
        </div>
      </div>
    </div>

  </div>

  <div class="overlay" id="pickerOverlay">
    <div class="picker">
      <div class="picker-header">
        <div id="pickerTitle">选择角色</div>
        <button class="ghost" id="pickerClose">关闭</button>
      </div>
      <input type="text" id="pickerSearch" placeholder="拼音 / 首字母 / 中文">
      <div class="picker-list" id="pickerList"></div>
    </div>
  </div>

  <script>
    const state = {
      survivors: [null, null, null, null],
      hunter: null,
      hunterBannedSurvivors: [],
      survivorBannedHunters: [],
      globalBannedSurvivors: [],
      globalBannedHunters: [],
      mapName: ''
    }
    const characters = { survivors: [], hunters: [], pinyinMap: {} }
    let pickerContext = null

    const mapSelect = document.getElementById('mapSelect')
    const applyMapBtn = document.getElementById('applyMapBtn')
    const resetBtn = document.getElementById('resetBtn')
    const resetKeepGlobalBtn = document.getElementById('resetKeepGlobalBtn')

    const pickerOverlay = document.getElementById('pickerOverlay')
    const pickerTitle = document.getElementById('pickerTitle')
    const pickerList = document.getElementById('pickerList')
    const pickerSearch = document.getElementById('pickerSearch')
    const pickerClose = document.getElementById('pickerClose')

    const survivorSlots = [
      document.getElementById('survivorSlot0'),
      document.getElementById('survivorSlot1'),
      document.getElementById('survivorSlot2'),
      document.getElementById('survivorSlot3')
    ]
    const hunterSlot = document.getElementById('hunterSlot')
    const banSurvivorList = document.getElementById('banSurvivorList')
    const banHunterList = document.getElementById('banHunterList')
    const globalBanSurvivorList = document.getElementById('globalBanSurvivorList')
    const globalBanHunterList = document.getElementById('globalBanHunterList')

    async function fetchJson(url, options) {
      const res = await fetch(url, options)
      return res.json()
    }

    function updateSlots() {
      survivorSlots.forEach((el, i) => {
        el.textContent = state.survivors[i] || '-'
      })
      hunterSlot.textContent = state.hunter || '-'
      if (state.mapName && mapSelect) {
        mapSelect.value = state.mapName
      }
    }

    function renderTagList(container, list, removeAction) {
      container.innerHTML = ''
      list.forEach(name => {
        const tag = document.createElement('div')
        tag.className = 'tag'
        tag.innerHTML = `${name}<span>×</span>`
        tag.addEventListener('click', () => sendAction(removeAction, { character: name }))
        container.appendChild(tag)
      })
    }

    function renderLists() {
      renderTagList(banSurvivorList, state.hunterBannedSurvivors, 'remove-ban-survivor')
      renderTagList(banHunterList, state.survivorBannedHunters, 'remove-ban-hunter')
      renderTagList(globalBanSurvivorList, state.globalBannedSurvivors, 'remove-global-ban-survivor')
      renderTagList(globalBanHunterList, state.globalBannedHunters, 'remove-global-ban-hunter')
    }

    function applyState(payload) {
      const normalized = payload?.currentRoundData
        ? {
            survivors: payload.currentRoundData.selectedSurvivors || [null, null, null, null],
            hunter: payload.currentRoundData.selectedHunter || null,
            hunterBannedSurvivors: payload.currentRoundData.hunterBannedSurvivors || [],
            survivorBannedHunters: payload.currentRoundData.survivorBannedHunters || [],
            globalBannedSurvivors: payload.globalBannedSurvivors || [],
            globalBannedHunters: payload.globalBannedHunters || [],
            mapName: payload.mapName || payload.currentMap || ''
          }
        : {
            survivors: payload?.survivors || [null, null, null, null],
            hunter: payload?.hunter || null,
            hunterBannedSurvivors: payload?.hunterBannedSurvivors || [],
            survivorBannedHunters: payload?.survivorBannedHunters || [],
            globalBannedSurvivors: payload?.globalBannedSurvivors || [],
            globalBannedHunters: payload?.globalBannedHunters || [],
            mapName: payload?.mapName || ''
          }

      state.survivors = [...normalized.survivors]
      state.hunter = normalized.hunter
      state.hunterBannedSurvivors = [...normalized.hunterBannedSurvivors]
      state.survivorBannedHunters = [...normalized.survivorBannedHunters]
      state.globalBannedSurvivors = [...normalized.globalBannedSurvivors]
      state.globalBannedHunters = [...normalized.globalBannedHunters]
      state.mapName = normalized.mapName || ''
      updateSlots()
      renderLists()
    }

    async function sendAction(action, data) {
      try {
        const res = await fetchJson('/api/local-bp-action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action, data })
        })
        return res
      } catch {
        return { success: false }
      }
    }


    function getSearchScore(name, query) {
      if (!query) return 0
      const q = query.toLowerCase()
      const nameLower = typeof name === 'string' ? name.toLowerCase() : ''
      if (nameLower.includes(q)) return 100
      const entry = characters.pinyinMap[name]
      if (entry) {
        const initials = (entry.initials || '').toLowerCase()
        const full = (entry.full || '').toLowerCase()
        if (initials === q) return 90
        if (initials.startsWith(q)) return 80
        if (full.startsWith(q)) return 70
      }
      return 0
    }

    function getFilteredList(list, query) {
      if (!query) return list.slice()
      return list
        .map(name => ({ name, score: getSearchScore(name, query) }))
        .filter(item => item.score > 0)
        .sort((a, b) => b.score - a.score)
        .map(item => item.name)
    }

    function openPicker(mode, index) {
      pickerContext = { mode, index }
      const group = mode.includes('hunter') ? 'hunters' : 'survivors'
      pickerContext.group = group
      pickerTitle.textContent = mode
      pickerSearch.value = ''
      renderPicker()
      pickerOverlay.classList.add('active')
    }

    function closePicker() {
      pickerOverlay.classList.remove('active')
      pickerContext = null
    }

    function renderPicker() {
      if (!pickerContext) return
      const list = characters[pickerContext.group] || []
      const query = pickerSearch.value.trim()
      const filtered = getFilteredList(list, query)
      pickerList.innerHTML = ''
      filtered.forEach(name => {
        const item = document.createElement('div')
        item.className = 'picker-item'
        item.textContent = name
        item.addEventListener('click', async () => {
          if (pickerContext.mode === 'survivor') {
            await sendAction('set-survivor', { index: pickerContext.index, character: name })
          } else if (pickerContext.mode === 'hunter') {
            await sendAction('set-hunter', { character: name })
          } else if (pickerContext.mode === 'ban-survivor') {
            await sendAction('add-ban-survivor', { character: name })
          } else if (pickerContext.mode === 'ban-hunter') {
            await sendAction('add-ban-hunter', { character: name })
          } else if (pickerContext.mode === 'global-survivor') {
            await sendAction('add-global-ban-survivor', { character: name })
          } else if (pickerContext.mode === 'global-hunter') {
            await sendAction('add-global-ban-hunter', { character: name })
          }
          closePicker()
        })
        pickerList.appendChild(item)
      })
    }

    function selectByQuickInput(mode, index, query) {
      const group = mode.includes('hunter') ? 'hunters' : 'survivors'
      const list = characters[group] || []
      const filtered = getFilteredList(list, query)
      const name = filtered[0]
      if (!name) return
      if (mode === 'survivor') return sendAction('set-survivor', { index, character: name })
      if (mode === 'hunter') return sendAction('set-hunter', { character: name })
      if (mode === 'ban-survivor') return sendAction('add-ban-survivor', { character: name })
      if (mode === 'ban-hunter') return sendAction('add-ban-hunter', { character: name })
      if (mode === 'global-survivor') return sendAction('add-global-ban-survivor', { character: name })
      if (mode === 'global-hunter') return sendAction('add-global-ban-hunter', { character: name })
    }

    async function resetBp(keepGlobal) {
      if (keepGlobal) {
        await sendAction('set-survivor', { index: 0, character: null })
        await sendAction('set-survivor', { index: 1, character: null })
        await sendAction('set-survivor', { index: 2, character: null })
        await sendAction('set-survivor', { index: 3, character: null })
        await sendAction('set-hunter', { character: null })

        for (const name of [...state.hunterBannedSurvivors]) {
          await sendAction('remove-ban-survivor', { character: name })
        }
        for (const name of [...state.survivorBannedHunters]) {
          await sendAction('remove-ban-hunter', { character: name })
        }

        state.survivors = [null, null, null, null]
        state.hunter = null
        state.hunterBannedSurvivors = []
        state.survivorBannedHunters = []
        updateSlots()
        renderLists()
        return
      }
      await sendAction('reset', {})
      state.survivors = [null, null, null, null]
      state.hunter = null
      state.hunterBannedSurvivors = []
      state.survivorBannedHunters = []
      state.globalBannedSurvivors = []
      state.globalBannedHunters = []
      updateSlots()
      renderLists()
    }

    async function loadMaps() {
      try {
        const res = await fetchJson('/api/maps')
        if (res && res.success && Array.isArray(res.maps)) {
          mapSelect.innerHTML = ''
          const empty = document.createElement('option')
          empty.value = ''
          empty.textContent = '选择地图'
          mapSelect.appendChild(empty)
          res.maps.forEach(name => {
            const opt = document.createElement('option')
            opt.value = name
            opt.textContent = name
            mapSelect.appendChild(opt)
          })
        }
      } catch {}
    }

    async function loadCharacters() {
      try {
        const res = await fetchJson('/api/local-bp-characters')
        if (res && res.success && res.data) {
          characters.survivors = Array.isArray(res.data.survivors) ? res.data.survivors : []
          characters.hunters = Array.isArray(res.data.hunters) ? res.data.hunters : []
          characters.pinyinMap = res.data.pinyinMap || {}
        }
      } catch {}
    }

    async function loadInitialState() {
      try {
        const res = await fetchJson('/api/current-state')
        if (res && res.state) {
          applyState(res.state)
        }
      } catch {}
      try {
        const res = await fetchJson('/api/local-bp-state')
        if (res && res.success && res.data) {
          applyState(res.data)
        }
      } catch {}
    }

    function setupSse() {
      const es = new EventSource('/api/sse')
      es.addEventListener('state-update', (e) => {
        try {
          const data = JSON.parse(e.data)
          applyState(data.state || data)
        } catch {}
      })
      es.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data)
          if (data?.type === 'local-bp-update') {
            applyState(data.payload)
          }
        } catch {}
      }
      window.addEventListener('beforeunload', () => es.close())
    }

    document.querySelectorAll('[data-pick]').forEach(btn => {
      btn.addEventListener('click', () => {
        const mode = btn.dataset.pick
        const index = btn.dataset.index ? Number(btn.dataset.index) : null
        openPicker(mode, index)
      })
    })

    document.querySelectorAll('[data-clear]').forEach(btn => {
      btn.addEventListener('click', () => {
        const type = btn.dataset.clear
        const index = Number(btn.dataset.index)
        if (type === 'survivor') sendAction('set-survivor', { index, character: null })
        if (type === 'hunter') sendAction('set-hunter', { character: null })
      })
    })

    applyMapBtn.addEventListener('click', () => {
      const mapName = mapSelect.value || ''
      sendAction('set-map-name', { mapName })
    })

    resetBtn.addEventListener('click', () => {
      resetBp(false)
    })
    resetKeepGlobalBtn.addEventListener('click', () => {
      resetBp(true)
    })

    document.querySelectorAll('[data-quick]').forEach(input => {
      input.addEventListener('keydown', (event) => {
        if (event.key !== 'Enter') return
        const mode = input.dataset.quick
        const index = input.dataset.index ? Number(input.dataset.index) : null
        const query = input.value.trim()
        if (!query) return
        selectByQuickInput(mode, index, query)
        input.value = ''
      })
    })

    pickerSearch.addEventListener('keydown', (event) => {
      if (event.key !== 'Enter') return
      if (!pickerContext) return
      const list = characters[pickerContext.group] || []
      const query = pickerSearch.value.trim()
      const filtered = getFilteredList(list, query)
      const name = filtered[0]
      if (!name) return
      if (pickerContext.mode === 'survivor') {
        sendAction('set-survivor', { index: pickerContext.index, character: name })
      } else if (pickerContext.mode === 'hunter') {
        sendAction('set-hunter', { character: name })
      } else if (pickerContext.mode === 'ban-survivor') {
        sendAction('add-ban-survivor', { character: name })
      } else if (pickerContext.mode === 'ban-hunter') {
        sendAction('add-ban-hunter', { character: name })
      } else if (pickerContext.mode === 'global-survivor') {
        sendAction('add-global-ban-survivor', { character: name })
      } else if (pickerContext.mode === 'global-hunter') {
        sendAction('add-global-ban-hunter', { character: name })
      }
      closePicker()
    })

    pickerClose.addEventListener('click', closePicker)
    pickerOverlay.addEventListener('click', (e) => {
      if (e.target === pickerOverlay) closePicker()
    })
    pickerSearch.addEventListener('input', renderPicker)

    Promise.all([loadMaps(), loadCharacters(), loadInitialState()]).then(setupSse)
  </script>
</body>
</html>
