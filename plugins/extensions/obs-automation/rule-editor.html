<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OBS è‡ªåŠ¨åŒ– - è§„åˆ™ç¼–è¾‘å™¨</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', sans-serif;
      background: #1e1e2e;
      color: #cdd6f4;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* é¡¶éƒ¨å·¥å…·æ  */
    .toolbar {
      background: #313244;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #45475a;
      flex-shrink: 0;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .toolbar h1 {
      font-size: 18px;
      color: #89b4fa;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .obs-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 6px;
      background: #1e1e2e;
    }

    .obs-status.connected {
      color: #a6e3a1;
    }

    .obs-status.disconnected {
      color: #f38ba8;
    }

    .toolbar-buttons {
      display: flex;
      gap: 8px;
    }

    /* ä¸»å†…å®¹åŒº */
    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* å·¦ä¾§é¢æ¿ - è¿æ¥è®¾ç½®å’Œè§„åˆ™åˆ—è¡¨ */
    .left-panel {
      width: 320px;
      background: #181825;
      border-right: 1px solid #45475a;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    /* è¿æ¥è®¾ç½®åŒº */
    .connection-section {
      padding: 16px;
      border-bottom: 1px solid #45475a;
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: #89b4fa;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .form-group {
      flex: 1;
    }

    .form-group label {
      display: block;
      font-size: 11px;
      color: #a6adc8;
      margin-bottom: 4px;
    }

    .form-group input {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #45475a;
      border-radius: 4px;
      background: #313244;
      color: #cdd6f4;
      font-size: 13px;
    }

    .form-group input:focus {
      outline: none;
      border-color: #89b4fa;
    }

    .connection-buttons {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    /* è§„åˆ™åˆ—è¡¨åŒº */
    .rules-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .rules-header {
      padding: 12px 16px;
      background: #1e1e2e;
      border-bottom: 1px solid #45475a;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .rules-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .rule-item {
      padding: 12px;
      margin-bottom: 8px;
      background: #313244;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .rule-item:hover {
      background: #45475a;
    }

    .rule-item.selected {
      border-color: #89b4fa;
      background: rgba(137, 180, 250, 0.1);
    }

    .rule-item.disabled {
      opacity: 0.5;
    }

    .rule-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .rule-item-name {
      font-weight: 600;
      font-size: 14px;
    }

    .rule-item-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .rule-item-badge.enabled {
      background: rgba(166, 227, 161, 0.2);
      color: #a6e3a1;
    }

    .rule-item-badge.disabled {
      background: rgba(243, 139, 168, 0.2);
      color: #f38ba8;
    }

    .rule-item-event {
      font-size: 12px;
      color: #a6adc8;
    }

    /* å³ä¾§ç¼–è¾‘åŒº */
    .editor-area {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .editor-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #6c7086;
    }

    .editor-empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    /* è¡¨å•åŒºå— */
    .form-section {
      background: #313244;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .form-section-title {
      font-size: 14px;
      font-weight: 600;
      color: #89b4fa;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-section .form-row {
      margin-bottom: 12px;
    }

    .form-section .form-group input,
    .form-section .form-group select,
    .form-section .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #45475a;
      border-radius: 6px;
      background: #1e1e2e;
      color: #cdd6f4;
      font-size: 14px;
    }

    .form-section textarea {
      resize: vertical;
      min-height: 60px;
      font-family: inherit;
    }

    .hint {
      font-size: 11px;
      color: #6c7086;
      margin-top: 4px;
    }

    /* åŠ¨ä½œåˆ—è¡¨ */
    .actions-list {
      margin-top: 8px;
    }

    .action-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: #1e1e2e;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .action-item select,
    .action-item input {
      padding: 8px 10px;
      border: 1px solid #45475a;
      border-radius: 4px;
      background: #313244;
      color: #cdd6f4;
      font-size: 13px;
    }

    .action-item select {
      flex: 0 0 140px;
    }

    .action-item input {
      flex: 1;
    }

    .action-order {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #45475a;
      border-radius: 50%;
      font-size: 12px;
      font-weight: bold;
      color: #cdd6f4;
    }

    .action-remove {
      background: #f38ba8;
      color: #1e1e2e;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .action-remove:hover {
      background: #eba0ac;
    }

    /* æŒ‰é’®æ ·å¼ */
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: #89b4fa;
      color: #1e1e2e;
    }

    .btn-primary:hover {
      background: #b4befe;
    }

    .btn-success {
      background: #a6e3a1;
      color: #1e1e2e;
    }

    .btn-success:hover {
      background: #94e2d5;
    }

    .btn-danger {
      background: #f38ba8;
      color: #1e1e2e;
    }

    .btn-danger:hover {
      background: #eba0ac;
    }

    .btn-secondary {
      background: #45475a;
      color: #cdd6f4;
    }

    .btn-secondary:hover {
      background: #585b70;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    /* å¼€å…³æ ·å¼ */
    .switch {
      position: relative;
      width: 44px;
      height: 24px;
      display: inline-block;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .switch-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #45475a;
      transition: 0.3s;
      border-radius: 24px;
    }

    .switch-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: #cdd6f4;
      transition: 0.3s;
      border-radius: 50%;
    }

    .switch input:checked+.switch-slider {
      background-color: #a6e3a1;
    }

    .switch input:checked+.switch-slider:before {
      transform: translateX(20px);
    }

    /* å¤é€‰æ¡† */
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #89b4fa;
    }

    /* æŒ‰é’®åŒºåŸŸ */
    .editor-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #45475a;
    }

    /* æ»šåŠ¨æ¡æ ·å¼ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #181825;
    }

    ::-webkit-scrollbar-thumb {
      background: #45475a;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #585b70;
    }

    /* æ¶ˆæ¯æç¤º */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    .toast.success {
      background: #a6e3a1;
      color: #1e1e2e;
    }

    .toast.error {
      background: #f38ba8;
      color: #1e1e2e;
    }

    .toast.info {
      background: #89b4fa;
      color: #1e1e2e;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>

<body>
  <!-- é¡¶éƒ¨å·¥å…·æ  -->
  <div class="toolbar">
    <div class="toolbar-left">
      <h1>ğŸ“‹ OBS è‡ªåŠ¨åŒ–è§„åˆ™ç¼–è¾‘å™¨</h1>
      <div id="obsStatus" class="obs-status disconnected">
        <span>âšª</span>
        <span>æœªè¿æ¥ OBS</span>
      </div>
    </div>
    <div class="toolbar-buttons">
      <button class="btn-success" onclick="saveAllRules()">ğŸ’¾ ä¿å­˜æ‰€æœ‰è§„åˆ™</button>
    </div>
  </div>

  <div class="main-content">
    <!-- å·¦ä¾§é¢æ¿ -->
    <div class="left-panel">
      <!-- è¿æ¥è®¾ç½® -->
      <div class="connection-section">
        <div class="section-title">ğŸ”Œ OBS è¿æ¥è®¾ç½®</div>
        <div class="form-row">
          <div class="form-group">
            <label>ä¸»æœº</label>
            <input type="text" id="obsHost" value="localhost" placeholder="localhost">
          </div>
          <div class="form-group" style="flex: 0 0 80px;">
            <label>ç«¯å£</label>
            <input type="number" id="obsPort" value="4455" placeholder="4455">
          </div>
        </div>
        <div class="form-group">
          <label>å¯†ç  (å¯é€‰)</label>
          <input type="password" id="obsPassword" placeholder="WebSocket å¯†ç ">
        </div>
        <div class="checkbox-group" style="margin-top: 8px;">
          <input type="checkbox" id="autoConnect">
          <label for="autoConnect" style="font-size: 12px; color: #a6adc8;">å¯åŠ¨æ—¶è‡ªåŠ¨è¿æ¥</label>
        </div>
        <div class="connection-buttons">
          <button class="btn-success btn-sm" id="connectBtn" onclick="connectOBS()">è¿æ¥</button>
          <button class="btn-danger btn-sm" id="disconnectBtn" onclick="disconnectOBS()"
            style="display: none;">æ–­å¼€</button>
          <button class="btn-secondary btn-sm" onclick="saveConnectionConfig()">ä¿å­˜è®¾ç½®</button>
        </div>
      </div>

      <!-- è§„åˆ™åˆ—è¡¨ -->
      <div class="rules-section">
        <div class="rules-header">
          <span class="section-title" style="margin: 0;">ğŸ“œ è§„åˆ™åˆ—è¡¨</span>
          <button class="btn-primary btn-sm" onclick="createNewRule()">+ æ–°å»º</button>
        </div>
        <div class="rules-list" id="rulesList">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>

    <!-- å³ä¾§ç¼–è¾‘åŒº -->
    <div class="editor-area" id="editorArea">
      <!-- ç©ºçŠ¶æ€ -->
      <div class="editor-empty" id="editorEmpty">
        <div class="editor-empty-icon">ğŸ“‹</div>
        <div>é€‰æ‹©ä¸€ä¸ªè§„åˆ™è¿›è¡Œç¼–è¾‘</div>
        <div style="margin-top: 8px; font-size: 14px;">æˆ–ç‚¹å‡» "æ–°å»º" åˆ›å»ºæ–°è§„åˆ™</div>
      </div>

      <!-- è§„åˆ™ç¼–è¾‘è¡¨å• -->
      <div id="editorForm" style="display: none;">
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="form-section">
          <div class="form-section-title">ğŸ“ åŸºæœ¬ä¿¡æ¯</div>
          <div class="form-row">
            <div class="form-group" style="flex: 2;">
              <label>è§„åˆ™åç§°</label>
              <input type="text" id="ruleName" placeholder="ä¾‹å¦‚ï¼šç›‘ç®¡è€…é€‰å®Œååˆ‡æ¢åœºæ™¯">
            </div>
            <div class="form-group" style="flex: 0 0 80px;">
              <label>å¯ç”¨</label>
              <label class="switch" style="margin-top: 6px;">
                <input type="checkbox" id="ruleEnabled" checked>
                <span class="switch-slider"></span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <label>æè¿° (å¯é€‰)</label>
            <input type="text" id="ruleDescription" placeholder="è§„åˆ™çš„è¯¦ç»†æè¿°">
          </div>
        </div>

        <!-- è§¦å‘æ¡ä»¶ -->
        <div class="form-section">
          <div class="form-section-title">âš¡ è§¦å‘æ¡ä»¶</div>
          <div class="form-row">
            <div class="form-group">
              <label>è§¦å‘äº‹ä»¶</label>
              <select id="ruleTriggerType">
                <optgroup label="BP äº‹ä»¶">
                  <option value="bp:started">BP å¼€å§‹</option>
                  <option value="bp:ended">BP ç»“æŸ</option>
                  <option value="bp:hunter-selected">ç›‘ç®¡è€…é€‰æ‹©å®Œæˆ</option>
                  <option value="bp:survivor-selected">æ±‚ç”Ÿè€…é€‰æ‹© (æ¯ä¸ª)</option>
                  <option value="bp:all-survivors-selected">æ‰€æœ‰æ±‚ç”Ÿè€…é€‰å®Œ</option>
                  <option value="bp:character-banned">è§’è‰²è¢« Ban</option>
                  <option value="bp:round-changed">BP å›åˆå˜åŒ–</option>
                </optgroup>
                <optgroup label="æ¯”èµ›äº‹ä»¶">
                  <option value="match:started">æ¯”èµ›å¼€å§‹</option>
                  <option value="match:ended">æ¯”èµ›ç»“æŸ</option>
                  <option value="match:score-updated">æ¯”åˆ†æ›´æ–°</option>
                  <option value="match:map-changed">åœ°å›¾å˜åŒ–</option>
                </optgroup>
                <optgroup label="æˆ¿é—´äº‹ä»¶">
                  <option value="room:connected">æˆ¿é—´è¿æ¥</option>
                  <option value="room:disconnected">æˆ¿é—´æ–­å¼€</option>
                  <option value="room:updated">æˆ¿é—´æ•°æ®æ›´æ–°</option>
                </optgroup>
              </select>
            </div>
            <div class="form-group" style="flex: 0 0 120px;">
              <label>å»¶è¿Ÿ (ç§’)</label>
              <input type="number" id="ruleDelay" value="0" min="0" step="0.5" placeholder="0">
              <div class="hint">è§¦å‘åç­‰å¾…æ—¶é—´</div>
            </div>
          </div>
          <div class="form-group">
            <label>æ¡ä»¶è¡¨è¾¾å¼ (å¯é€‰)</label>
            <input type="text" id="ruleCondition" placeholder="ä¾‹å¦‚: data.hunter === 'æ°å…‹'">
            <div class="hint">JavaScript è¡¨è¾¾å¼ï¼Œè¿”å› true æ—¶æ‰æ‰§è¡ŒåŠ¨ä½œ</div>
          </div>
        </div>

        <!-- æ‰§è¡ŒåŠ¨ä½œ -->
        <div class="form-section">
          <div class="form-section-title">ğŸ¬ æ‰§è¡ŒåŠ¨ä½œ</div>
          <div class="hint" style="margin-bottom: 12px;">åŠ¨ä½œæŒ‰é¡ºåºæ‰§è¡Œï¼Œå¯ä»¥æ·»åŠ å¤šä¸ªåŠ¨ä½œå’Œå»¶è¿Ÿ</div>
          <div id="actionsList" class="actions-list">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
          </div>
          <button class="btn-secondary btn-sm" onclick="addAction()" style="margin-top: 8px;">+ æ·»åŠ åŠ¨ä½œ</button>
        </div>

        <!-- é«˜çº§é€‰é¡¹ -->
        <div class="form-section">
          <div class="form-section-title">âš™ï¸ é«˜çº§é€‰é¡¹</div>
          <div class="form-row">
            <div class="form-group">
              <label>å†·å´æ—¶é—´ (ç§’)</label>
              <input type="number" id="ruleCooldown" value="0" min="0" placeholder="0">
              <div class="hint">è§„åˆ™è§¦å‘åçš„å†·å´æ—¶é—´</div>
            </div>
            <div class="form-group">
              <label>æœ€å¤§è§¦å‘æ¬¡æ•°</label>
              <input type="number" id="ruleMaxTriggers" value="0" min="0" placeholder="0 = æ— é™åˆ¶">
              <div class="hint">0 è¡¨ç¤ºæ— é™åˆ¶</div>
            </div>
          </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="editor-buttons">
          <button class="btn-primary" onclick="saveCurrentRule()">ğŸ’¾ ä¿å­˜è§„åˆ™</button>
          <button class="btn-secondary" onclick="testCurrentRule()">ğŸ§ª æµ‹è¯•è§„åˆ™</button>
          <button class="btn-danger" onclick="deleteCurrentRule()">ğŸ—‘ï¸ åˆ é™¤è§„åˆ™</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // çŠ¶æ€
    let rules = []
    let scenes = []
    let currentRuleIndex = -1
    let isConnected = false

    // äº‹ä»¶ç±»å‹æ˜ å°„ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
    const triggerTypeNames = {
      'bp:started': 'BP å¼€å§‹',
      'bp:ended': 'BP ç»“æŸ',
      'bp:hunter-selected': 'ğŸ¯ ç›‘ç®¡è€…é€‰æ‹©å®Œæˆ',
      'bp:survivor-selected': 'ğŸ‘¥ æ±‚ç”Ÿè€…é€‰æ‹©',
      'bp:all-survivors-selected': 'ğŸ‘¥ æ‰€æœ‰æ±‚ç”Ÿè€…é€‰å®Œ',
      'bp:character-banned': 'ğŸš« è§’è‰²è¢« Ban',
      'bp:round-changed': 'ğŸ”„ BP å›åˆå˜åŒ–',
      'match:started': 'ğŸ® æ¯”èµ›å¼€å§‹',
      'match:ended': 'ğŸ æ¯”èµ›ç»“æŸ',
      'match:score-updated': 'ğŸ“Š æ¯”åˆ†æ›´æ–°',
      'match:map-changed': 'ğŸ—ºï¸ åœ°å›¾å˜åŒ–',
      'room:connected': 'ğŸ”— æˆ¿é—´è¿æ¥',
      'room:disconnected': 'âŒ æˆ¿é—´æ–­å¼€',
      'room:updated': 'ğŸ“¡ æˆ¿é—´æ•°æ®æ›´æ–°'
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      await loadConfig()
      await loadRules()
      await updateOBSStatus()

      // ç›‘å¬çŠ¶æ€å˜åŒ–
      if (window.obsAPI) {
        window.obsAPI.onStatus(handleStatusUpdate)
      }
    })

    // åŠ è½½é…ç½®
    async function loadConfig() {
      try {
        const config = await window.obsAPI.getConfig()
        document.getElementById('obsHost').value = config.host || 'localhost'
        document.getElementById('obsPort').value = config.port || 4455
        document.getElementById('obsPassword').value = config.password || ''
        document.getElementById('autoConnect').checked = config.autoConnect || false
      } catch (e) {
        console.error('åŠ è½½é…ç½®å¤±è´¥:', e)
      }
    }

    // åŠ è½½è§„åˆ™
    async function loadRules() {
      try {
        rules = await window.obsAPI.getRules()
        renderRulesList()
      } catch (e) {
        console.error('åŠ è½½è§„åˆ™å¤±è´¥:', e)
        rules = []
      }
    }

    // æ›´æ–° OBS çŠ¶æ€
    async function updateOBSStatus() {
      try {
        const status = await window.obsAPI.getStatus()
        handleStatusUpdate(status)
      } catch (e) {
        console.error('è·å–çŠ¶æ€å¤±è´¥:', e)
      }
    }

    // å¤„ç†çŠ¶æ€æ›´æ–°
    function handleStatusUpdate(status) {
      isConnected = status.connected
      scenes = status.scenes || []

      const statusEl = document.getElementById('obsStatus')
      const connectBtn = document.getElementById('connectBtn')
      const disconnectBtn = document.getElementById('disconnectBtn')

      if (status.connected) {
        statusEl.className = 'obs-status connected'
        statusEl.innerHTML = `<span>ğŸŸ¢</span><span>å·²è¿æ¥ - ${status.currentScene || 'æœªçŸ¥åœºæ™¯'}</span>`
        connectBtn.style.display = 'none'
        disconnectBtn.style.display = 'inline-flex'
      } else {
        statusEl.className = 'obs-status disconnected'
        statusEl.innerHTML = '<span>âšª</span><span>æœªè¿æ¥ OBS</span>'
        connectBtn.style.display = 'inline-flex'
        disconnectBtn.style.display = 'none'
      }

      // å¦‚æœæ­£åœ¨ç¼–è¾‘è§„åˆ™ï¼Œæ›´æ–°åœºæ™¯é€‰æ‹©å™¨
      if (currentRuleIndex >= 0) {
        const actionsList = document.getElementById('actionsList')
        const selects = actionsList.querySelectorAll('select[data-param="sceneName"]')
        selects.forEach(updateSceneOptions)
      }
    }

    // æ›´æ–°åœºæ™¯é€‰é¡¹
    function updateSceneOptions(select) {
      const currentValue = select.value
      let options = '<option value="">-- é€‰æ‹©åœºæ™¯ --</option>'
      scenes.forEach(scene => {
        options += `<option value="${scene}" ${scene === currentValue ? 'selected' : ''}>${scene}</option>`
      })
      select.innerHTML = options
    }

    // è¿æ¥ OBS
    async function connectOBS() {
      const config = {
        host: document.getElementById('obsHost').value,
        port: parseInt(document.getElementById('obsPort').value) || 4455,
        password: document.getElementById('obsPassword').value,
        autoConnect: document.getElementById('autoConnect').checked
      }

      try {
        const result = await window.obsAPI.connect(config)
        if (result.success) {
          showToast('å·²è¿æ¥åˆ° OBS', 'success')
        } else {
          showToast('è¿æ¥å¤±è´¥: ' + result.error, 'error')
        }
      } catch (e) {
        showToast('è¿æ¥å¤±è´¥: ' + e.message, 'error')
      }
    }

    // æ–­å¼€ OBS
    async function disconnectOBS() {
      await window.obsAPI.disconnect()
      showToast('å·²æ–­å¼€è¿æ¥', 'info')
    }

    // ä¿å­˜è¿æ¥é…ç½®
    async function saveConnectionConfig() {
      const config = {
        host: document.getElementById('obsHost').value,
        port: parseInt(document.getElementById('obsPort').value) || 4455,
        password: document.getElementById('obsPassword').value,
        autoConnect: document.getElementById('autoConnect').checked
      }

      await window.obsAPI.saveConfig(config)
      showToast('è¿æ¥è®¾ç½®å·²ä¿å­˜', 'success')
    }

    // æ¸²æŸ“è§„åˆ™åˆ—è¡¨
    function renderRulesList() {
      const container = document.getElementById('rulesList')

      if (rules.length === 0) {
        container.innerHTML = `
          <div style="padding: 20px; text-align: center; color: #6c7086;">
            æš‚æ— è§„åˆ™<br><br>
            ç‚¹å‡» "æ–°å»º" åˆ›å»ºè§„åˆ™
          </div>
        `
        return
      }

      container.innerHTML = rules.map((rule, index) => `
        <div class="rule-item ${index === currentRuleIndex ? 'selected' : ''} ${!rule.enabled ? 'disabled' : ''}" 
             onclick="selectRule(${index})">
          <div class="rule-item-header">
            <span class="rule-item-name">${rule.name || 'æœªå‘½åè§„åˆ™'}</span>
            <span class="rule-item-badge ${rule.enabled ? 'enabled' : 'disabled'}">
              ${rule.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
            </span>
          </div>
          <div class="rule-item-event">${triggerTypeNames[rule.triggerType] || rule.triggerType}</div>
        </div>
      `).join('')
    }

    // é€‰æ‹©è§„åˆ™
    function selectRule(index) {
      currentRuleIndex = index
      renderRulesList()
      showRuleEditor(rules[index])
    }

    // æ˜¾ç¤ºè§„åˆ™ç¼–è¾‘å™¨
    function showRuleEditor(rule) {
      document.getElementById('editorEmpty').style.display = 'none'
      document.getElementById('editorForm').style.display = 'block'

      document.getElementById('ruleName').value = rule.name || ''
      document.getElementById('ruleDescription').value = rule.description || ''
      document.getElementById('ruleEnabled').checked = rule.enabled !== false
      document.getElementById('ruleTriggerType').value = rule.triggerType || 'bp:hunter-selected'
      document.getElementById('ruleDelay').value = (rule.delay || 0) / 1000 // è½¬æ¢ä¸ºç§’
      document.getElementById('ruleCondition').value = rule.condition || ''
      document.getElementById('ruleCooldown').value = (rule.cooldown || 0) / 1000
      document.getElementById('ruleMaxTriggers').value = rule.maxTriggers || 0

      renderActions(rule.actions || [])
    }

    // æ¸²æŸ“åŠ¨ä½œåˆ—è¡¨
    function renderActions(actions) {
      const container = document.getElementById('actionsList')

      if (!actions || actions.length === 0) {
        actions = [{ type: 'SWITCH_SCENE', enabled: true, params: { sceneName: '' } }]
      }

      container.innerHTML = actions.map((action, index) => `
        <div class="action-item" data-index="${index}">
          <span class="action-order">${index + 1}</span>
          <select onchange="updateActionType(${index}, this.value)">
            <option value="SWITCH_SCENE" ${action.type === 'SWITCH_SCENE' ? 'selected' : ''}>åˆ‡æ¢åœºæ™¯</option>
            <option value="DELAY" ${action.type === 'DELAY' ? 'selected' : ''}>ç­‰å¾…å»¶è¿Ÿ</option>
            <option value="SET_TEXT" ${action.type === 'SET_TEXT' ? 'selected' : ''}>è®¾ç½®æ–‡æœ¬</option>
            <option value="SET_IMAGE" ${action.type === 'SET_IMAGE' ? 'selected' : ''}>è®¾ç½®å›¾ç‰‡</option>
            <option value="SET_BROWSER_URL" ${action.type === 'SET_BROWSER_URL' ? 'selected' : ''}>è®¾ç½®æµè§ˆå™¨URL</option>
            <option value="SET_SOURCE_SETTINGS" ${action.type === 'SET_SOURCE_SETTINGS' ? 'selected' : ''}>æºè®¾ç½®(é€šç”¨)</option>
            <option value="SET_SOURCE_TRANSFORM" ${action.type === 'SET_SOURCE_TRANSFORM' ? 'selected' : ''}>æºå˜æ¢</option>
            <option value="SET_FILTER_SETTINGS" ${action.type === 'SET_FILTER_SETTINGS' ? 'selected' : ''}>æ»¤é•œè®¾ç½®</option>
            <option value="SET_FILTER_ENABLED" ${action.type === 'SET_FILTER_ENABLED' ? 'selected' : ''}>å¯ç”¨/ç¦ç”¨æ»¤é•œ</option>
            <option value="START_RECORDING" ${action.type === 'START_RECORDING' ? 'selected' : ''}>å¼€å§‹å½•åˆ¶</option>
            <option value="STOP_RECORDING" ${action.type === 'STOP_RECORDING' ? 'selected' : ''}>åœæ­¢å½•åˆ¶</option>
            <option value="START_STREAMING" ${action.type === 'START_STREAMING' ? 'selected' : ''}>å¼€å§‹æ¨æµ</option>
            <option value="STOP_STREAMING" ${action.type === 'STOP_STREAMING' ? 'selected' : ''}>åœæ­¢æ¨æµ</option>
          </select>
          ${renderActionParams(action, index)}
          <button class="action-remove" onclick="removeAction(${index})" title="åˆ é™¤">Ã—</button>
        </div>
      `).join('')
    }

    // æ¸²æŸ“åŠ¨ä½œå‚æ•°
    function renderActionParams(action, index) {
      const params = action.params || {}

      switch (action.type) {
        case 'SWITCH_SCENE':
          let sceneOptions = '<option value="">-- é€‰æ‹©åœºæ™¯ --</option>'
          scenes.forEach(s => {
            sceneOptions += `<option value="${s}" ${params.sceneName === s ? 'selected' : ''}>${s}</option>`
          })
          return `
            <select data-param="sceneName" onchange="updateActionParam(${index}, 'sceneName', this.value)">
              ${sceneOptions}
            </select>
            <input type="text" placeholder="æˆ–æ‰‹åŠ¨è¾“å…¥åœºæ™¯å" value="${params.sceneName || ''}" 
                   onchange="updateActionParam(${index}, 'sceneName', this.value)" style="flex: 0.8;">
          `
        case 'DELAY':
          return `
            <input type="number" placeholder="å»¶è¿Ÿç§’æ•°" value="${(params.duration || 0) / 1000}" min="0" step="0.5"
                   onchange="updateActionParam(${index}, 'duration', parseFloat(this.value) * 1000)">
            <span style="color: #6c7086; font-size: 12px;">ç§’</span>
          `
        case 'SET_TEXT':
          return `
            <input type="text" placeholder="æºåç§°" value="${params.sourceName || ''}" style="flex: 0.6;"
                   onchange="updateActionParam(${index}, 'sourceName', this.value)">
            <input type="text" placeholder="æ–‡æœ¬å†…å®¹ (æ”¯æŒå˜é‡ {{bpHunter}})" value="${params.text || ''}" style="flex: 1.4;"
                   onchange="updateActionParam(${index}, 'text', this.value)">
          `
        case 'SET_IMAGE':
          return `
            <input type="text" placeholder="æºåç§°" value="${params.sourceName || ''}" style="flex: 0.6;"
                   onchange="updateActionParam(${index}, 'sourceName', this.value)">
            <input type="text" placeholder="å›¾ç‰‡è·¯å¾„ (æ”¯æŒå˜é‡)" value="${params.file || ''}" style="flex: 1.4;"
                   onchange="updateActionParam(${index}, 'file', this.value)">
          `
        case 'SET_BROWSER_URL':
          return `
            <input type="text" placeholder="æºåç§°" value="${params.sourceName || ''}" style="flex: 0.6;"
                   onchange="updateActionParam(${index}, 'sourceName', this.value)">
            <input type="text" placeholder="URL" value="${params.url || ''}" style="flex: 1.4;"
                   onchange="updateActionParam(${index}, 'url', this.value)">
          `
        case 'SET_SOURCE_SETTINGS':
          return `
            <input type="text" placeholder="æºåç§°" value="${params.sourceName || ''}" style="flex: 0.6;"
                   onchange="updateActionParam(${index}, 'sourceName', this.value)">
            <input type="text" placeholder="è®¾ç½® JSON (ä¾‹: {&quot;color&quot;: 4294901760})" value="${JSON.stringify(params.settings || {})}" style="flex: 1.4;"
                   onchange="try { updateActionParam(${index}, 'settings', JSON.parse(this.value)) } catch(e) { alert('JSONæ ¼å¼é”™è¯¯') }">
          `
        case 'SET_SOURCE_TRANSFORM':
          const transformJson = JSON.stringify(params.transform || { positionX: 0, positionY: 0, scaleX: 1, scaleY: 1 })
          return `
            <input type="text" placeholder="åœºæ™¯å" value="${params.sceneName || ''}" style="flex: 0.5;"
                   onchange="updateActionParam(${index}, 'sceneName', this.value)">
            <input type="text" placeholder="æºåç§°" value="${params.sourceName || ''}" style="flex: 0.5;"
                   onchange="updateActionParam(${index}, 'sourceName', this.value)">
            <input type="text" placeholder="å˜æ¢ JSON (positionX, positionY, scaleX, scaleY)" value="${transformJson}" style="flex: 1;"
                   onchange="try { updateActionParam(${index}, 'transform', JSON.parse(this.value)) } catch(e) { alert('JSONæ ¼å¼é”™è¯¯') }">
          `
        case 'SET_FILTER_SETTINGS':
          return `
            <input type="text" placeholder="æºåç§°" value="${params.sourceName || ''}" style="flex: 0.5;"
                   onchange="updateActionParam(${index}, 'sourceName', this.value)">
            <input type="text" placeholder="æ»¤é•œåç§°" value="${params.filterName || ''}" style="flex: 0.5;"
                   onchange="updateActionParam(${index}, 'filterName', this.value)">
            <input type="text" placeholder="è®¾ç½® JSON" value="${JSON.stringify(params.settings || {})}" style="flex: 1;"
                   onchange="try { updateActionParam(${index}, 'settings', JSON.parse(this.value)) } catch(e) { alert('JSONæ ¼å¼é”™è¯¯') }">
          `
        case 'SET_FILTER_ENABLED':
          return `
            <input type="text" placeholder="æºåç§°" value="${params.sourceName || ''}" style="flex: 0.6;"
                   onchange="updateActionParam(${index}, 'sourceName', this.value)">
            <input type="text" placeholder="æ»¤é•œåç§°" value="${params.filterName || ''}" style="flex: 0.6;"
                   onchange="updateActionParam(${index}, 'filterName', this.value)">
            <select onchange="updateActionParam(${index}, 'enabled', this.value === 'true')" style="flex: 0.4;">
              <option value="true" ${params.enabled === true ? 'selected' : ''}>å¯ç”¨</option>
              <option value="false" ${params.enabled === false ? 'selected' : ''}>ç¦ç”¨</option>
            </select>
          `
        default:
          return '<span style="color: #6c7086; font-size: 12px;">æ— éœ€å‚æ•°</span>'
      }
    }

    // æ·»åŠ åŠ¨ä½œ
    function addAction() {
      if (currentRuleIndex < 0) return

      if (!rules[currentRuleIndex].actions) {
        rules[currentRuleIndex].actions = []
      }
      rules[currentRuleIndex].actions.push({ type: 'SWITCH_SCENE', enabled: true, params: { sceneName: '' } })
      renderActions(rules[currentRuleIndex].actions)
    }

    // ç§»é™¤åŠ¨ä½œ
    function removeAction(index) {
      if (currentRuleIndex < 0) return
      rules[currentRuleIndex].actions.splice(index, 1)
      renderActions(rules[currentRuleIndex].actions)
    }

    // æ›´æ–°åŠ¨ä½œç±»å‹
    function updateActionType(index, type) {
      if (currentRuleIndex < 0) return
      rules[currentRuleIndex].actions[index] = { type, enabled: true, params: {} }
      renderActions(rules[currentRuleIndex].actions)
    }

    // æ›´æ–°åŠ¨ä½œå‚æ•°
    function updateActionParam(index, param, value) {
      if (currentRuleIndex < 0) return
      if (!rules[currentRuleIndex].actions[index].params) {
        rules[currentRuleIndex].actions[index].params = {}
      }
      rules[currentRuleIndex].actions[index].params[param] = value
    }

    // åˆ›å»ºæ–°è§„åˆ™
    function createNewRule() {
      const newRule = {
        id: 'rule_' + Date.now(),
        name: 'æ–°è§„åˆ™',
        description: '',
        enabled: true,
        triggerType: 'bp:hunter-selected',
        delay: 0,
        cooldown: 0,
        maxTriggers: 0,
        condition: '',
        actions: [{ type: 'SWITCH_SCENE', enabled: true, params: { sceneName: '' } }]
      }
      rules.push(newRule)
      currentRuleIndex = rules.length - 1
      renderRulesList()
      showRuleEditor(newRule)
    }

    // ä¿å­˜å½“å‰è§„åˆ™
    async function saveCurrentRule() {
      if (currentRuleIndex < 0) return

      rules[currentRuleIndex] = {
        ...rules[currentRuleIndex],
        name: document.getElementById('ruleName').value || 'æœªå‘½åè§„åˆ™',
        description: document.getElementById('ruleDescription').value,
        enabled: document.getElementById('ruleEnabled').checked,
        triggerType: document.getElementById('ruleTriggerType').value,
        delay: parseFloat(document.getElementById('ruleDelay').value) * 1000 || 0,
        cooldown: parseFloat(document.getElementById('ruleCooldown').value) * 1000 || 0,
        maxTriggers: parseInt(document.getElementById('ruleMaxTriggers').value) || 0,
        condition: document.getElementById('ruleCondition').value,
        // ğŸ”¥ é‡è¦ï¼šä¿å­˜ actionsï¼å¦åˆ™æ‰€æœ‰åŠ¨ä½œé…ç½®éƒ½ä¼šä¸¢å¤±
        actions: rules[currentRuleIndex].actions || []
      }

      renderRulesList()

      // ä¿å­˜å½“å‰è§„åˆ™åç«‹å³æŒä¹…åŒ–å…¨éƒ¨è§„åˆ™åˆ°ç£ç›˜
      try {
        await window.obsAPI.saveRules(rules)
        showToast('âœ… è§„åˆ™å·²ä¿å­˜åˆ°ç£ç›˜', 'success')
      } catch (e) {
        showToast('âŒ ä¿å­˜å¤±è´¥: ' + e.message, 'error')
      }
    }

    // åˆ é™¤å½“å‰è§„åˆ™
    function deleteCurrentRule() {
      if (currentRuleIndex < 0) return
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿ')) return

      rules.splice(currentRuleIndex, 1)
      currentRuleIndex = -1
      renderRulesList()

      document.getElementById('editorEmpty').style.display = 'flex'
      document.getElementById('editorForm').style.display = 'none'

      showToast('è§„åˆ™å·²åˆ é™¤', 'info')
    }

    // æµ‹è¯•å½“å‰è§„åˆ™
    async function testCurrentRule() {
      if (currentRuleIndex < 0) return

      // å…ˆä¿å­˜å½“å‰ç¼–è¾‘
      saveCurrentRule()

      const rule = rules[currentRuleIndex]
      try {
        await window.obsAPI.testRule(rule)
        showToast('æµ‹è¯•äº‹ä»¶å·²è§¦å‘', 'success')
      } catch (e) {
        showToast('æµ‹è¯•å¤±è´¥: ' + e.message, 'error')
      }
    }

    // ä¿å­˜æ‰€æœ‰è§„åˆ™
    async function saveAllRules() {
      // å…ˆä¿å­˜å½“å‰ç¼–è¾‘çš„è§„åˆ™
      if (currentRuleIndex >= 0) {
        saveCurrentRule()
      }

      try {
        await window.obsAPI.saveRules(rules)
        showToast(`å·²ä¿å­˜ ${rules.length} æ¡è§„åˆ™`, 'success')
      } catch (e) {
        showToast('ä¿å­˜å¤±è´¥: ' + e.message, 'error')
      }
    }

    // æ˜¾ç¤º Toast æ¶ˆæ¯
    function showToast(message, type = 'info') {
      const toast = document.createElement('div')
      toast.className = `toast ${type}`
      toast.textContent = message
      document.body.appendChild(toast)

      setTimeout(() => {
        toast.remove()
      }, 3000)
    }
  </script>
</body>

</html>