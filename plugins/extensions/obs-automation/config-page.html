<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OBS è‡ªåŠ¨åŒ–é…ç½®</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #1a1a2e;
      color: #eee;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #9f7aea;
      border-bottom: 1px solid #333;
      padding-bottom: 8px;
    }
    
    .card {
      background: #16213e;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    .status-bar {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #666;
    }
    
    .status-dot.connected {
      background: #4ade80;
      box-shadow: 0 0 10px #4ade80;
    }
    
    .status-dot.disconnected {
      background: #f87171;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      color: #a0aec0;
    }
    
    input[type="text"],
    input[type="number"],
    input[type="password"],
    select,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #333;
      border-radius: 8px;
      background: #0f0f23;
      color: #eee;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #9f7aea;
    }
    
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #38a169, #2f855a);
      color: white;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #e53e3e, #c53030);
      color: white;
    }
    
    .btn-secondary {
      background: #4a5568;
      color: white;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .rules-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .rule-item {
      background: #0f0f23;
      border-radius: 8px;
      padding: 15px;
      border: 1px solid #333;
      transition: border-color 0.2s;
    }
    
    .rule-item:hover {
      border-color: #9f7aea;
    }
    
    .rule-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .rule-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .rule-name {
      font-weight: 600;
      font-size: 16px;
    }
    
    .rule-badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .badge-enabled {
      background: #22543d;
      color: #68d391;
    }
    
    .badge-disabled {
      background: #742a2a;
      color: #fc8181;
    }
    
    .rule-description {
      color: #a0aec0;
      font-size: 13px;
      margin-bottom: 10px;
    }
    
    .rule-meta {
      display: flex;
      gap: 15px;
      font-size: 12px;
      color: #718096;
    }
    
    .rule-actions {
      display: flex;
      gap: 8px;
    }
    
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #4a5568;
      transition: 0.3s;
      border-radius: 24px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    
    .toggle-switch input:checked + .toggle-slider {
      background-color: #9f7aea;
    }
    
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background: #16213e;
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal h3 {
      font-size: 20px;
      margin-bottom: 20px;
    }
    
    .action-item {
      background: #0f0f23;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid #333;
    }
    
    .action-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .scene-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    
    .scene-btn {
      padding: 8px 16px;
      background: #0f0f23;
      border: 1px solid #333;
      border-radius: 6px;
      color: #eee;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .scene-btn:hover {
      border-color: #9f7aea;
      background: #1a1a3e;
    }
    
    .scene-btn.active {
      border-color: #9f7aea;
      background: #9f7aea;
      color: white;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #718096;
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    }
    
    .tab-btn {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: #a0aec0;
      font-size: 14px;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.2s;
    }
    
    .tab-btn:hover {
      color: #eee;
      background: rgba(159, 122, 234, 0.1);
    }
    
    .tab-btn.active {
      color: #9f7aea;
      background: rgba(159, 122, 234, 0.2);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .help-text {
      font-size: 12px;
      color: #718096;
      margin-top: 4px;
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      z-index: 2000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
    }
    
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .toast.success {
      background: #38a169;
    }
    
    .toast.error {
      background: #e53e3e;
    }
    
    .toast.info {
      background: #3182ce;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¬ OBS è‡ªåŠ¨åŒ–é…ç½®</h1>
    
    <!-- çŠ¶æ€æ  -->
    <div class="card">
      <div class="status-bar">
        <div class="status-item">
          <div class="status-dot" id="obsStatusDot"></div>
          <span id="obsStatusText">æœªè¿æ¥</span>
        </div>
        <div class="status-item">
          <span>å½“å‰åœºæ™¯:</span>
          <strong id="currentScene">-</strong>
        </div>
        <div class="status-item">
          <span>æ´»åŠ¨è§„åˆ™:</span>
          <strong id="activeRuleCount">0</strong> æ¡
        </div>
        <div style="flex: 1;"></div>
        <div class="button-group">
          <button class="btn-success" id="connectBtn">è¿æ¥ OBS</button>
          <button class="btn-danger" id="disconnectBtn" style="display: none;">æ–­å¼€è¿æ¥</button>
        </div>
      </div>
    </div>
    
    <!-- é€‰é¡¹å¡ -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="connection">è¿æ¥è®¾ç½®</button>
      <button class="tab-btn" data-tab="rules">è‡ªåŠ¨åŒ–è§„åˆ™</button>
      <button class="tab-btn" data-tab="scenes">å¿«æ·åœºæ™¯</button>
      <button class="tab-btn" data-tab="test">æµ‹è¯•å·¥å…·</button>
    </div>
    
    <!-- è¿æ¥è®¾ç½® -->
    <div class="tab-content active" id="tab-connection">
      <div class="card">
        <h2>ğŸ”— OBS WebSocket è¿æ¥è®¾ç½®</h2>
        <div class="form-row">
          <div class="form-group">
            <label>æœåŠ¡å™¨åœ°å€</label>
            <input type="text" id="obsHost" value="localhost" placeholder="localhost">
            <p class="help-text">OBS æ‰€åœ¨ç”µè„‘çš„ IP åœ°å€ï¼Œæœ¬æœºä½¿ç”¨ localhost</p>
          </div>
          <div class="form-group">
            <label>ç«¯å£</label>
            <input type="number" id="obsPort" value="4455" placeholder="4455">
            <p class="help-text">OBS WebSocket 5.x é»˜è®¤ç«¯å£ä¸º 4455</p>
          </div>
          <div class="form-group">
            <label>å¯†ç </label>
            <input type="password" id="obsPassword" placeholder="ç•™ç©ºè¡¨ç¤ºæ— å¯†ç ">
            <p class="help-text">åœ¨ OBS -> å·¥å…· -> WebSocket æœåŠ¡å™¨è®¾ç½® ä¸­æŸ¥çœ‹</p>
          </div>
        </div>
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="autoConnect">
            <label for="autoConnect" style="margin: 0;">å¯åŠ¨æ—¶è‡ªåŠ¨è¿æ¥ OBS</label>
          </div>
        </div>
        <div class="button-group" style="margin-top: 20px;">
          <button class="btn-primary" id="saveConfigBtn">ä¿å­˜è®¾ç½®</button>
          <button class="btn-secondary" id="testConnectionBtn">æµ‹è¯•è¿æ¥</button>
        </div>
      </div>
    </div>
    
    <!-- è‡ªåŠ¨åŒ–è§„åˆ™ -->
    <div class="tab-content" id="tab-rules">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h2 style="margin: 0; border: none; padding: 0;">ğŸ“‹ è‡ªåŠ¨åŒ–è§„åˆ™</h2>
          <div class="button-group">
            <button class="btn-primary" id="addRuleBtn">â• æ·»åŠ è§„åˆ™</button>
            <button class="btn-secondary" id="importRulesBtn">ğŸ“¥ å¯¼å…¥</button>
            <button class="btn-secondary" id="exportRulesBtn">ğŸ“¤ å¯¼å‡º</button>
          </div>
        </div>
        
        <div class="rules-list" id="rulesList">
          <!-- è§„åˆ™åˆ—è¡¨å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>
    
    <!-- å¿«æ·åœºæ™¯ -->
    <div class="tab-content" id="tab-scenes">
      <div class="card">
        <h2>ğŸ¬ å¿«æ·åœºæ™¯åˆ‡æ¢</h2>
        <p class="help-text" style="margin-bottom: 15px;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¿«é€Ÿåˆ‡æ¢ OBS åœºæ™¯ï¼ˆéœ€è¦å…ˆè¿æ¥ OBSï¼‰</p>
        <div class="scene-list" id="sceneList">
          <div class="empty-state">
            <div class="icon">ğŸ“º</div>
            <p>è¯·å…ˆè¿æ¥ OBS ä»¥è·å–åœºæ™¯åˆ—è¡¨</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æµ‹è¯•å·¥å…· -->
    <div class="tab-content" id="tab-test">
      <div class="card">
        <h2>ğŸ§ª äº‹ä»¶æµ‹è¯•å·¥å…·</h2>
        <p class="help-text" style="margin-bottom: 15px;">æ¨¡æ‹Ÿè§¦å‘å„ç§äº‹ä»¶æ¥æµ‹è¯•ä½ çš„è‡ªåŠ¨åŒ–è§„åˆ™</p>
        
        <div class="form-row">
          <div class="form-group">
            <label>é€‰æ‹©äº‹ä»¶ç±»å‹</label>
            <select id="testEventType">
              <optgroup label="BP äº‹ä»¶">
                <option value="bp:started">BP å¼€å§‹</option>
                <option value="bp:ended">BP ç»“æŸ</option>
                <option value="bp:hunter-selected">ç›‘ç®¡è€…é€‰æ‹©å®Œæˆ</option>
                <option value="bp:survivor-selected">æ±‚ç”Ÿè€…é€‰æ‹©</option>
                <option value="bp:all-survivors-selected">æ‰€æœ‰æ±‚ç”Ÿè€…é€‰æ‹©å®Œæˆ</option>
                <option value="bp:character-banned">è§’è‰²è¢« Ban</option>
                <option value="bp:round-changed">å›åˆå˜åŒ–</option>
              </optgroup>
              <optgroup label="æ¯”èµ›äº‹ä»¶">
                <option value="match:started">æ¯”èµ›å¼€å§‹</option>
                <option value="match:ended">æ¯”èµ›ç»“æŸ</option>
                <option value="match:score-updated">æ¯”åˆ†æ›´æ–°</option>
                <option value="match:map-changed">åœ°å›¾å˜åŒ–</option>
              </optgroup>
              <optgroup label="æˆ¿é—´äº‹ä»¶">
                <option value="room:connected">æˆ¿é—´è¿æ¥</option>
                <option value="room:disconnected">æˆ¿é—´æ–­å¼€</option>
                <option value="room:updated">æˆ¿é—´æ•°æ®æ›´æ–°</option>
              </optgroup>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label>äº‹ä»¶æ•°æ® (JSON)</label>
          <textarea id="testEventData" rows="5" placeholder='{"hunter": "çº¢è¶", "survivors": ["åŒ»ç”Ÿ", "ç©ºå†›", "å‰é”‹", "è°ƒé¦™å¸ˆ"]}'></textarea>
        </div>
        
        <div class="button-group">
          <button class="btn-primary" id="triggerTestBtn">ğŸš€ è§¦å‘æµ‹è¯•äº‹ä»¶</button>
        </div>
      </div>
      
      <div class="card">
        <h2>ğŸ“œ äº‹ä»¶æ—¥å¿—</h2>
        <div id="eventLog" style="background: #0f0f23; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 13px;">
          <p style="color: #718096;">ç­‰å¾…äº‹ä»¶...</p>
        </div>
        <button class="btn-secondary btn-sm" id="clearLogBtn" style="margin-top: 10px;">æ¸…ç©ºæ—¥å¿—</button>
      </div>
    </div>
  </div>
  
  <!-- è§„åˆ™ç¼–è¾‘æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="ruleModal">
    <div class="modal">
      <h3 id="ruleModalTitle">æ·»åŠ è§„åˆ™</h3>
      
      <div class="form-group">
        <label>è§„åˆ™åç§°</label>
        <input type="text" id="ruleName" placeholder="ä¾‹å¦‚ï¼šç›‘ç®¡è€…é€‰å®Œåˆ‡åœºæ™¯">
      </div>
      
      <div class="form-group">
        <label>è§„åˆ™æè¿°</label>
        <input type="text" id="ruleDescription" placeholder="æè¿°è¿™ä¸ªè§„åˆ™çš„ä½œç”¨">
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>è§¦å‘äº‹ä»¶</label>
          <select id="ruleTriggerType">
            <optgroup label="BP äº‹ä»¶">
              <option value="bp:started">BP å¼€å§‹</option>
              <option value="bp:ended">BP ç»“æŸ</option>
              <option value="bp:hunter-selected">ç›‘ç®¡è€…é€‰æ‹©å®Œæˆ</option>
              <option value="bp:survivor-selected">æ±‚ç”Ÿè€…é€‰æ‹©</option>
              <option value="bp:all-survivors-selected">æ‰€æœ‰æ±‚ç”Ÿè€…é€‰æ‹©å®Œæˆ</option>
              <option value="bp:character-banned">è§’è‰²è¢« Ban</option>
              <option value="bp:round-changed">å›åˆå˜åŒ–</option>
            </optgroup>
            <optgroup label="æ¯”èµ›äº‹ä»¶">
              <option value="match:started">æ¯”èµ›å¼€å§‹</option>
              <option value="match:ended">æ¯”èµ›ç»“æŸ</option>
              <option value="match:score-updated">æ¯”åˆ†æ›´æ–°</option>
              <option value="match:map-changed">åœ°å›¾å˜åŒ–</option>
            </optgroup>
            <optgroup label="æˆ¿é—´äº‹ä»¶">
              <option value="room:connected">æˆ¿é—´è¿æ¥</option>
              <option value="room:disconnected">æˆ¿é—´æ–­å¼€</option>
              <option value="room:updated">æˆ¿é—´æ•°æ®æ›´æ–°</option>
            </optgroup>
          </select>
        </div>
        
        <div class="form-group">
          <label>å†·å´æ—¶é—´ (æ¯«ç§’)</label>
          <input type="number" id="ruleCooldown" value="0" min="0" placeholder="0">
          <p class="help-text">é˜²æ­¢è§„åˆ™é¢‘ç¹è§¦å‘ï¼Œ0 è¡¨ç¤ºæ— å†·å´</p>
        </div>
      </div>
      
      <div class="form-group">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <label style="margin: 0;">æ“ä½œåˆ—è¡¨</label>
          <button class="btn-secondary btn-sm" id="addActionBtn">â• æ·»åŠ æ“ä½œ</button>
        </div>
        <div id="actionsList">
          <!-- æ“ä½œåˆ—è¡¨å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
      
      <div class="button-group" style="margin-top: 20px; justify-content: flex-end;">
        <button class="btn-secondary" id="cancelRuleBtn">å–æ¶ˆ</button>
        <button class="btn-primary" id="saveRuleBtn">ä¿å­˜è§„åˆ™</button>
      </div>
    </div>
  </div>
  
  <!-- Toast é€šçŸ¥ -->
  <div class="toast" id="toast"></div>
  
  <script>
    // æ•°æ®å­˜å‚¨
    let config = {
      host: 'localhost',
      port: 4455,
      password: '',
      autoConnect: false
    }
    let rules = []
    let scenes = []
    let connected = false
    let currentScene = null
    let editingRuleId = null
    let currentActions = []
    
    // DOM å…ƒç´ 
    const elements = {
      obsStatusDot: document.getElementById('obsStatusDot'),
      obsStatusText: document.getElementById('obsStatusText'),
      currentScene: document.getElementById('currentScene'),
      activeRuleCount: document.getElementById('activeRuleCount'),
      connectBtn: document.getElementById('connectBtn'),
      disconnectBtn: document.getElementById('disconnectBtn'),
      obsHost: document.getElementById('obsHost'),
      obsPort: document.getElementById('obsPort'),
      obsPassword: document.getElementById('obsPassword'),
      autoConnect: document.getElementById('autoConnect'),
      rulesList: document.getElementById('rulesList'),
      sceneList: document.getElementById('sceneList'),
      eventLog: document.getElementById('eventLog'),
      ruleModal: document.getElementById('ruleModal'),
      toast: document.getElementById('toast')
    }
    
    // åˆå§‹åŒ–
    function init() {
      setupTabs()
      setupEventListeners()
      
      // ç›‘å¬æ¥è‡ªä¸»è¿›ç¨‹çš„æ¶ˆæ¯
      if (window.electronAPI) {
        window.electronAPI.onPluginMessage?.('obs-automation:init', (data) => {
          config = data.config || config
          rules = data.rules || []
          connected = data.connected
          scenes = data.scenes || []
          currentScene = data.currentScene
          
          updateUI()
        })
        
        window.electronAPI.onPluginMessage?.('obs-automation:status', (data) => {
          connected = data.connected
          currentScene = data.currentScene
          scenes = data.scenes || scenes
          updateConnectionStatus()
          renderScenes()
        })
        
        window.electronAPI.onPluginMessage?.('obs-automation:log', (message) => {
          appendLog(message)
        })
      }
    }
    
    // è®¾ç½®é€‰é¡¹å¡
    function setupTabs() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tabId = btn.dataset.tab
          
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'))
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'))
          
          btn.classList.add('active')
          document.getElementById(`tab-${tabId}`).classList.add('active')
        })
      })
    }
    
    // è®¾ç½®äº‹ä»¶ç›‘å¬
    function setupEventListeners() {
      // è¿æ¥æŒ‰é’®
      elements.connectBtn.addEventListener('click', connectOBS)
      elements.disconnectBtn.addEventListener('click', disconnectOBS)
      
      // ä¿å­˜é…ç½®
      document.getElementById('saveConfigBtn').addEventListener('click', saveConfig)
      document.getElementById('testConnectionBtn').addEventListener('click', testConnection)
      
      // è§„åˆ™æ“ä½œ
      document.getElementById('addRuleBtn').addEventListener('click', () => openRuleModal())
      document.getElementById('importRulesBtn').addEventListener('click', importRules)
      document.getElementById('exportRulesBtn').addEventListener('click', exportRules)
      
      // æ¨¡æ€æ¡†
      document.getElementById('cancelRuleBtn').addEventListener('click', closeRuleModal)
      document.getElementById('saveRuleBtn').addEventListener('click', saveRule)
      document.getElementById('addActionBtn').addEventListener('click', addAction)
      
      // æµ‹è¯•å·¥å…·
      document.getElementById('triggerTestBtn').addEventListener('click', triggerTestEvent)
      document.getElementById('clearLogBtn').addEventListener('click', clearLog)
    }
    
    // æ›´æ–° UI
    function updateUI() {
      // æ›´æ–°è¡¨å•
      elements.obsHost.value = config.host || 'localhost'
      elements.obsPort.value = config.port || 4455
      elements.obsPassword.value = config.password || ''
      elements.autoConnect.checked = config.autoConnect || false
      
      updateConnectionStatus()
      renderRules()
      renderScenes()
    }
    
    // æ›´æ–°è¿æ¥çŠ¶æ€
    function updateConnectionStatus() {
      if (connected) {
        elements.obsStatusDot.className = 'status-dot connected'
        elements.obsStatusText.textContent = 'å·²è¿æ¥'
        elements.connectBtn.style.display = 'none'
        elements.disconnectBtn.style.display = 'inline-block'
      } else {
        elements.obsStatusDot.className = 'status-dot disconnected'
        elements.obsStatusText.textContent = 'æœªè¿æ¥'
        elements.connectBtn.style.display = 'inline-block'
        elements.disconnectBtn.style.display = 'none'
      }
      
      elements.currentScene.textContent = currentScene || '-'
      elements.activeRuleCount.textContent = rules.filter(r => r.enabled).length
    }
    
    // æ¸²æŸ“è§„åˆ™åˆ—è¡¨
    function renderRules() {
      if (rules.length === 0) {
        elements.rulesList.innerHTML = `
          <div class="empty-state">
            <div class="icon">ğŸ“‹</div>
            <p>æš‚æ— è§„åˆ™ï¼Œç‚¹å‡»"æ·»åŠ è§„åˆ™"åˆ›å»ºä½ çš„ç¬¬ä¸€æ¡è‡ªåŠ¨åŒ–è§„åˆ™</p>
          </div>
        `
        return
      }
      
      elements.rulesList.innerHTML = rules.map(rule => `
        <div class="rule-item" data-id="${rule.id}">
          <div class="rule-header">
            <div class="rule-title">
              <span class="rule-name">${escapeHtml(rule.name)}</span>
              <span class="rule-badge ${rule.enabled ? 'badge-enabled' : 'badge-disabled'}">
                ${rule.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
              </span>
            </div>
            <div class="rule-actions">
              <label class="toggle-switch">
                <input type="checkbox" ${rule.enabled ? 'checked' : ''} onchange="toggleRule('${rule.id}', this.checked)">
                <span class="toggle-slider"></span>
              </label>
              <button class="btn-secondary btn-sm" onclick="editRule('${rule.id}')">ç¼–è¾‘</button>
              <button class="btn-danger btn-sm" onclick="deleteRule('${rule.id}')">åˆ é™¤</button>
            </div>
          </div>
          <div class="rule-description">${escapeHtml(rule.description || 'æ— æè¿°')}</div>
          <div class="rule-meta">
            <span>è§¦å‘: ${getTriggerTypeLabel(rule.triggerType)}</span>
            <span>æ“ä½œ: ${rule.actions?.length || 0} ä¸ª</span>
            ${rule.cooldown > 0 ? `<span>å†·å´: ${rule.cooldown}ms</span>` : ''}
          </div>
        </div>
      `).join('')
      
      elements.activeRuleCount.textContent = rules.filter(r => r.enabled).length
    }
    
    // æ¸²æŸ“åœºæ™¯åˆ—è¡¨
    function renderScenes() {
      if (!connected || scenes.length === 0) {
        elements.sceneList.innerHTML = `
          <div class="empty-state">
            <div class="icon">ğŸ“º</div>
            <p>${connected ? 'æœªæ‰¾åˆ°åœºæ™¯' : 'è¯·å…ˆè¿æ¥ OBS ä»¥è·å–åœºæ™¯åˆ—è¡¨'}</p>
          </div>
        `
        return
      }
      
      elements.sceneList.innerHTML = scenes.map(scene => `
        <button class="scene-btn ${scene === currentScene ? 'active' : ''}" onclick="switchScene('${escapeHtml(scene)}')">
          ${escapeHtml(scene)}
        </button>
      `).join('')
    }
    
    // è¿æ¥ OBS
    async function connectOBS() {
      showToast('æ­£åœ¨è¿æ¥...', 'info')
      
      if (window.electronAPI) {
        try {
          await window.electronAPI.executePluginCommand('obsAutomation.connect', {
            host: elements.obsHost.value,
            port: parseInt(elements.obsPort.value),
            password: elements.obsPassword.value
          })
        } catch (e) {
          showToast('è¿æ¥å¤±è´¥: ' + e.message, 'error')
        }
      }
    }
    
    // æ–­å¼€ OBS
    function disconnectOBS() {
      if (window.electronAPI) {
        window.electronAPI.executePluginCommand('obsAutomation.disconnect')
      }
    }
    
    // ä¿å­˜é…ç½®
    function saveConfig() {
      config = {
        host: elements.obsHost.value,
        port: parseInt(elements.obsPort.value),
        password: elements.obsPassword.value,
        autoConnect: elements.autoConnect.checked
      }
      
      if (window.electronAPI) {
        window.electronAPI.sendPluginMessage('obs-automation:saveConfig', config)
      }
      
      showToast('é…ç½®å·²ä¿å­˜', 'success')
    }
    
    // æµ‹è¯•è¿æ¥
    async function testConnection() {
      showToast('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info')
      await connectOBS()
    }
    
    // åˆ‡æ¢åœºæ™¯
    function switchScene(sceneName) {
      if (window.electronAPI) {
        window.electronAPI.executePluginCommand('obsAutomation.switchScene', sceneName)
        showToast(`æ­£åœ¨åˆ‡æ¢åˆ°: ${sceneName}`, 'info')
      }
    }
    
    // æ‰“å¼€è§„åˆ™æ¨¡æ€æ¡†
    function openRuleModal(ruleId = null) {
      editingRuleId = ruleId
      
      if (ruleId) {
        const rule = rules.find(r => r.id === ruleId)
        if (rule) {
          document.getElementById('ruleModalTitle').textContent = 'ç¼–è¾‘è§„åˆ™'
          document.getElementById('ruleName').value = rule.name
          document.getElementById('ruleDescription').value = rule.description || ''
          document.getElementById('ruleTriggerType').value = rule.triggerType
          document.getElementById('ruleCooldown').value = rule.cooldown || 0
          currentActions = [...(rule.actions || [])]
        }
      } else {
        document.getElementById('ruleModalTitle').textContent = 'æ·»åŠ è§„åˆ™'
        document.getElementById('ruleName').value = ''
        document.getElementById('ruleDescription').value = ''
        document.getElementById('ruleTriggerType').value = 'bp:hunter-selected'
        document.getElementById('ruleCooldown').value = 0
        currentActions = []
      }
      
      renderActions()
      elements.ruleModal.classList.add('active')
    }
    
    // å…³é—­è§„åˆ™æ¨¡æ€æ¡†
    function closeRuleModal() {
      elements.ruleModal.classList.remove('active')
      editingRuleId = null
      currentActions = []
    }
    
    // æ¸²æŸ“æ“ä½œåˆ—è¡¨
    function renderActions() {
      const container = document.getElementById('actionsList')
      
      if (currentActions.length === 0) {
        container.innerHTML = '<p style="color: #718096; text-align: center; padding: 20px;">æš‚æ— æ“ä½œï¼Œç‚¹å‡»"æ·»åŠ æ“ä½œ"</p>'
        return
      }
      
      container.innerHTML = currentActions.map((action, index) => `
        <div class="action-item">
          <div class="action-header">
            <span>æ“ä½œ ${index + 1}: ${getActionTypeLabel(action.type)}</span>
            <button class="btn-danger btn-sm" onclick="removeAction(${index})">åˆ é™¤</button>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>æ“ä½œç±»å‹</label>
              <select onchange="updateActionType(${index}, this.value)">
                <option value="switch-scene" ${action.type === 'switch-scene' ? 'selected' : ''}>åˆ‡æ¢åœºæ™¯</option>
                <option value="delay" ${action.type === 'delay' ? 'selected' : ''}>å»¶è¿Ÿç­‰å¾…</option>
                <option value="set-text" ${action.type === 'set-text' ? 'selected' : ''}>è®¾ç½®æ–‡æœ¬</option>
                <option value="set-browser-url" ${action.type === 'set-browser-url' ? 'selected' : ''}>è®¾ç½®æµè§ˆå™¨æº URL</option>
                <option value="refresh-browser" ${action.type === 'refresh-browser' ? 'selected' : ''}>åˆ·æ–°æµè§ˆå™¨æº</option>
                <option value="start-stream" ${action.type === 'start-stream' ? 'selected' : ''}>å¼€å§‹æ¨æµ</option>
                <option value="stop-stream" ${action.type === 'stop-stream' ? 'selected' : ''}>åœæ­¢æ¨æµ</option>
                <option value="start-record" ${action.type === 'start-record' ? 'selected' : ''}>å¼€å§‹å½•åˆ¶</option>
                <option value="stop-record" ${action.type === 'stop-record' ? 'selected' : ''}>åœæ­¢å½•åˆ¶</option>
              </select>
            </div>
            ${renderActionParams(action, index)}
          </div>
        </div>
      `).join('')
    }
    
    // æ¸²æŸ“æ“ä½œå‚æ•°
    function renderActionParams(action, index) {
      switch (action.type) {
        case 'switch-scene':
          return `
            <div class="form-group">
              <label>åœºæ™¯åç§°</label>
              <input type="text" value="${escapeHtml(action.params?.sceneName || '')}" 
                     onchange="updateActionParam(${index}, 'sceneName', this.value)"
                     placeholder="è¾“å…¥ OBS ä¸­çš„åœºæ™¯åç§°">
            </div>
          `
        case 'delay':
          return `
            <div class="form-group">
              <label>å»¶è¿Ÿæ—¶é—´ (æ¯«ç§’)</label>
              <input type="number" value="${action.params?.duration || 1000}" 
                     onchange="updateActionParam(${index}, 'duration', parseInt(this.value))"
                     min="0" placeholder="1000">
            </div>
          `
        case 'set-text':
          return `
            <div class="form-group">
              <label>æ–‡æœ¬æºåç§°</label>
              <input type="text" value="${escapeHtml(action.params?.sourceName || '')}" 
                     onchange="updateActionParam(${index}, 'sourceName', this.value)"
                     placeholder="OBS ä¸­çš„æ–‡æœ¬æºåç§°">
            </div>
            <div class="form-group">
              <label>æ–‡æœ¬å†…å®¹</label>
              <input type="text" value="${escapeHtml(action.params?.text || '')}" 
                     onchange="updateActionParam(${index}, 'text', this.value)"
                     placeholder="æ”¯æŒ {{å˜é‡}} è¯­æ³•">
            </div>
          `
        case 'set-browser-url':
          return `
            <div class="form-group">
              <label>æµè§ˆå™¨æºåç§°</label>
              <input type="text" value="${escapeHtml(action.params?.sourceName || '')}" 
                     onchange="updateActionParam(${index}, 'sourceName', this.value)">
            </div>
            <div class="form-group">
              <label>URL</label>
              <input type="text" value="${escapeHtml(action.params?.url || '')}" 
                     onchange="updateActionParam(${index}, 'url', this.value)">
            </div>
          `
        case 'refresh-browser':
          return `
            <div class="form-group">
              <label>æµè§ˆå™¨æºåç§°</label>
              <input type="text" value="${escapeHtml(action.params?.sourceName || '')}" 
                     onchange="updateActionParam(${index}, 'sourceName', this.value)">
            </div>
          `
        default:
          return ''
      }
    }
    
    // æ·»åŠ æ“ä½œ
    function addAction() {
      currentActions.push({
        type: 'switch-scene',
        delay: 0,
        params: {},
        enabled: true
      })
      renderActions()
    }
    
    // ç§»é™¤æ“ä½œ
    function removeAction(index) {
      currentActions.splice(index, 1)
      renderActions()
    }
    
    // æ›´æ–°æ“ä½œç±»å‹
    function updateActionType(index, type) {
      currentActions[index].type = type
      currentActions[index].params = {}
      renderActions()
    }
    
    // æ›´æ–°æ“ä½œå‚æ•°
    function updateActionParam(index, key, value) {
      if (!currentActions[index].params) {
        currentActions[index].params = {}
      }
      currentActions[index].params[key] = value
    }
    
    // ä¿å­˜è§„åˆ™
    function saveRule() {
      const name = document.getElementById('ruleName').value.trim()
      if (!name) {
        showToast('è¯·è¾“å…¥è§„åˆ™åç§°', 'error')
        return
      }
      
      if (currentActions.length === 0) {
        showToast('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæ“ä½œ', 'error')
        return
      }
      
      const rule = {
        id: editingRuleId || `rule-${Date.now()}`,
        name,
        description: document.getElementById('ruleDescription').value.trim(),
        triggerType: document.getElementById('ruleTriggerType').value,
        cooldown: parseInt(document.getElementById('ruleCooldown').value) || 0,
        actions: currentActions,
        enabled: editingRuleId ? rules.find(r => r.id === editingRuleId)?.enabled : true
      }
      
      if (editingRuleId) {
        const index = rules.findIndex(r => r.id === editingRuleId)
        if (index !== -1) {
          rules[index] = rule
        }
      } else {
        rules.push(rule)
      }
      
      // ä¿å­˜åˆ°ä¸»è¿›ç¨‹
      if (window.electronAPI) {
        window.electronAPI.sendPluginMessage('obs-automation:saveRules', rules)
      }
      
      renderRules()
      closeRuleModal()
      showToast('è§„åˆ™å·²ä¿å­˜', 'success')
    }
    
    // åˆ‡æ¢è§„åˆ™å¯ç”¨çŠ¶æ€
    function toggleRule(ruleId, enabled) {
      const rule = rules.find(r => r.id === ruleId)
      if (rule) {
        rule.enabled = enabled
        
        if (window.electronAPI) {
          window.electronAPI.sendPluginMessage('obs-automation:saveRules', rules)
        }
        
        renderRules()
      }
    }
    
    // ç¼–è¾‘è§„åˆ™
    function editRule(ruleId) {
      openRuleModal(ruleId)
    }
    
    // åˆ é™¤è§„åˆ™
    function deleteRule(ruleId) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿ')) {
        rules = rules.filter(r => r.id !== ruleId)
        
        if (window.electronAPI) {
          window.electronAPI.sendPluginMessage('obs-automation:saveRules', rules)
        }
        
        renderRules()
        showToast('è§„åˆ™å·²åˆ é™¤', 'success')
      }
    }
    
    // å¯¼å…¥è§„åˆ™
    function importRules() {
      const input = document.createElement('input')
      input.type = 'file'
      input.accept = '.json'
      input.onchange = (e) => {
        const file = e.target.files[0]
        if (file) {
          const reader = new FileReader()
          reader.onload = (e) => {
            try {
              const imported = JSON.parse(e.target.result)
              if (Array.isArray(imported)) {
                rules = [...rules, ...imported]
                
                if (window.electronAPI) {
                  window.electronAPI.sendPluginMessage('obs-automation:saveRules', rules)
                }
                
                renderRules()
                showToast(`å·²å¯¼å…¥ ${imported.length} æ¡è§„åˆ™`, 'success')
              }
            } catch (e) {
              showToast('å¯¼å…¥å¤±è´¥: æ— æ•ˆçš„ JSON æ–‡ä»¶', 'error')
            }
          }
          reader.readAsText(file)
        }
      }
      input.click()
    }
    
    // å¯¼å‡ºè§„åˆ™
    function exportRules() {
      const json = JSON.stringify(rules, null, 2)
      const blob = new Blob([json], { type: 'application/json' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = 'obs-automation-rules.json'
      a.click()
      URL.revokeObjectURL(url)
      showToast('è§„åˆ™å·²å¯¼å‡º', 'success')
    }
    
    // è§¦å‘æµ‹è¯•äº‹ä»¶
    function triggerTestEvent() {
      const eventType = document.getElementById('testEventType').value
      let eventData = {}
      
      try {
        const dataStr = document.getElementById('testEventData').value.trim()
        if (dataStr) {
          eventData = JSON.parse(dataStr)
        }
      } catch (e) {
        showToast('äº‹ä»¶æ•°æ®æ ¼å¼é”™è¯¯', 'error')
        return
      }
      
      appendLog(`ğŸš€ è§¦å‘æµ‹è¯•äº‹ä»¶: ${eventType}`)
      appendLog(`   æ•°æ®: ${JSON.stringify(eventData)}`)
      
      if (window.electronAPI) {
        window.electronAPI.executePluginCommand('obsAutomation.testTrigger', eventType, eventData)
      }
    }
    
    // æ·»åŠ æ—¥å¿—
    function appendLog(message) {
      const log = elements.eventLog
      const time = new Date().toLocaleTimeString()
      const entry = document.createElement('div')
      entry.textContent = `[${time}] ${message}`
      entry.style.marginBottom = '4px'
      
      // ç§»é™¤ç©ºçŠ¶æ€æç¤º
      if (log.querySelector('p')) {
        log.innerHTML = ''
      }
      
      log.appendChild(entry)
      log.scrollTop = log.scrollHeight
    }
    
    // æ¸…ç©ºæ—¥å¿—
    function clearLog() {
      elements.eventLog.innerHTML = '<p style="color: #718096;">ç­‰å¾…äº‹ä»¶...</p>'
    }
    
    // æ˜¾ç¤º Toast
    function showToast(message, type = 'info') {
      elements.toast.textContent = message
      elements.toast.className = `toast ${type} show`
      
      setTimeout(() => {
        elements.toast.classList.remove('show')
      }, 3000)
    }
    
    // è¾…åŠ©å‡½æ•°
    function escapeHtml(str) {
      if (!str) return ''
      return str.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;')
    }
    
    function getTriggerTypeLabel(type) {
      const labels = {
        'bp:started': 'BP å¼€å§‹',
        'bp:ended': 'BP ç»“æŸ',
        'bp:hunter-selected': 'ç›‘ç®¡è€…é€‰æ‹©å®Œæˆ',
        'bp:survivor-selected': 'æ±‚ç”Ÿè€…é€‰æ‹©',
        'bp:all-survivors-selected': 'æ‰€æœ‰æ±‚ç”Ÿè€…é€‰æ‹©å®Œæˆ',
        'bp:character-banned': 'è§’è‰²è¢« Ban',
        'bp:round-changed': 'å›åˆå˜åŒ–',
        'match:started': 'æ¯”èµ›å¼€å§‹',
        'match:ended': 'æ¯”èµ›ç»“æŸ',
        'match:score-updated': 'æ¯”åˆ†æ›´æ–°',
        'match:map-changed': 'åœ°å›¾å˜åŒ–',
        'room:connected': 'æˆ¿é—´è¿æ¥',
        'room:disconnected': 'æˆ¿é—´æ–­å¼€',
        'room:updated': 'æˆ¿é—´æ•°æ®æ›´æ–°'
      }
      return labels[type] || type
    }
    
    function getActionTypeLabel(type) {
      const labels = {
        'switch-scene': 'åˆ‡æ¢åœºæ™¯',
        'delay': 'å»¶è¿Ÿç­‰å¾…',
        'set-text': 'è®¾ç½®æ–‡æœ¬',
        'set-browser-url': 'è®¾ç½®æµè§ˆå™¨æº URL',
        'refresh-browser': 'åˆ·æ–°æµè§ˆå™¨æº',
        'start-stream': 'å¼€å§‹æ¨æµ',
        'stop-stream': 'åœæ­¢æ¨æµ',
        'start-record': 'å¼€å§‹å½•åˆ¶',
        'stop-record': 'åœæ­¢å½•åˆ¶'
      }
      return labels[type] || type
    }
    
    // å¯åŠ¨
    init()
  </script>
</body>
</html>
