# 比分系统说明

## ✅ 已完成的改进

### 1. 比分管理集成到后台
- ❌ **旧方案**：独立的比分板窗口（scoreboard.html）
- ✅ **新方案**：集成到后台管理页面（backend.html）

### 2. 与 WebSocket 房间同步
- 比分数据与当前 WebSocket 房间的 `roomId` 绑定
- 不同房间有独立的比分存档
- 自动根据房间的 BO 类型（BO1/BO3/BO5）初始化小局数量

### 3. 修复 WebSocket 重连问题
**问题**：创建一次对局后无法重新连接新对局

**解决方案**：
```javascript
// 在 connectToServer() 函数开头添加
if (connection) {
  await connection.stop()  // 先断开旧连接
}
```

现在可以：
- 创建第一个房间 → BP 流程 → 结束
- 返回主界面 → 创建新房间 → 正常连接 ✅

### 4. 数据持久化
- 使用 `localStorage` 保存比分数据
- Key 格式：`score_{roomId}`
- 每次修改小局比分时自动保存

## 📊 功能说明

### 侧边栏比分显示
- **大比分**：A队胜场 : B队胜场（大字号显示）
- **战绩统计**：
  - A队：X胜 Y平 Z负
  - B队：X胜 Y平 Z负

### 主区域比分管理
- **小局输入**：每局独立输入 A队/B队比分
- **自动计算**：
  - 小局 A > B → A队+1胜，B队+1负
  - 小局 A < B → B队+1胜，A队+1负
  - 小局 A = B → 双方各+1平
- **实时更新**：修改后立即更新侧边栏大比分

### 数据流程
```
创建房间（BO3）
    ↓
后台管理加载房间数据
    ↓
初始化 3 个小局（0:0, 0:0, 0:0）
    ↓
导播输入第1局比分（3:1）→ A队胜
    ↓
输入第2局比分（1:3）→ B队胜
    ↓
输入第3局比分（2:2）→ 平局
    ↓
最终大比分：A队 1胜1平0负 vs B队 1胜1平0负
```

## 🔧 使用流程

1. **创建房间**
   - 在主界面设置 BO 类型（BO1/BO3/BO5）
   - 点击"创建房间"

2. **管理比分**
   - 后台管理页面自动显示比分管理面板
   - 每局结束后，输入该局的小比分
   - 系统自动计算大比分和战绩

3. **查看比分**
   - 侧边栏实时显示当前大比分
   - 主区域显示所有小局详情

4. **创建新对局**
   - 返回主界面
   - 创建新房间（旧 WebSocket 连接会自动断开）
   - 新房间有独立的比分存档

## 💾 数据存储

### localStorage 结构
```json
{
  "score_房间ID": {
    "rounds": [
      { "teamA": 3, "teamB": 1 },
      { "teamA": 1, "teamB": 3 },
      { "teamA": 2, "teamB": 2 }
    ],
    "teamAWins": 1,
    "teamBWins": 1,
    "teamADraws": 1,
    "teamBDraws": 1
  }
}
```

### 自动保存时机
- 每次修改小局比分时
- 自动计算大比分后

## 🐛 已修复的问题

1. ✅ 比分与房间不对应 → 现在绑定 roomId
2. ✅ WebSocket 无法重连 → 添加 connection.stop()
3. ✅ 独立窗口管理混乱 → 集成到后台统一管理
4. ✅ BO 类型不同步 → 自动读取 roomData.boType

## 🎯 下一步优化建议

1. 添加"导出比分"功能（JSON/CSV）
2. 添加"重置比分"确认对话框
3. 支持从历史记录加载旧房间比分
4. 显示比赛时间戳
5. 支持备注功能（记录特殊情况）
